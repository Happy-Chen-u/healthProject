@model List<healthProject.Models.MissedRecordViewModel>
@{
    ViewData["Title"] = "個案健康資訊填寫狀況";
    Layout = null;

    // 🎯 關鍵修改：searchResult 從 ViewBag 獨立取得
    var searchResult = ViewBag.SearchResult as healthProject.Models.MissedRecordViewModel;
    var trackingList = ViewBag.TrackingList as List<healthProject.Models.MissedRecordViewModel> ?? new List<healthProject.Models.MissedRecordViewModel>();
    var activeTab = ViewBag.ActiveTab ?? "days2";

    // 使用完整資料計算徽章
    var allMissedDaysRecords = ViewBag.AllMissedDaysRecords as List<healthProject.Models.MissedRecordViewModel>
        ?? new List<healthProject.Models.MissedRecordViewModel>();

    // 計算各分類的數量
    var countDays2 = allMissedDaysRecords.Count(m => m.MissedDays == 2);
    var countDays3 = allMissedDaysRecords.Count(m => m.MissedDays == 3);
    var countDays4 = allMissedDaysRecords.Count(m => m.MissedDays == 4);
    var countDays5Plus = allMissedDaysRecords.Count(m => m.MissedDays >= 5 && m.MissedDays < 999);
    var countNever = allMissedDaysRecords.Count(m => m.MissedDays >= 999);
    var count722Missing = trackingList.Count(t => t.IsBothMissing || t.IsMorningMissing || t.IsEveningMissing);

    // 判斷是否有查詢條件
    bool hasSearch = !string.IsNullOrEmpty(ViewBag.SearchIdNumber);
}

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body {
            background: #f0f4f8;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }

        .main-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .page-header {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .page-title {
            color: #2c3e50;
            font-size: 1.8rem;
            font-weight: 600;
            margin: 0;
        }

        .search-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .search-result-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            margin-bottom: 1.5rem;
            border-left: 5px solid #667eea;
        }

        .result-header h5 {
            color: #667eea;
            font-weight: 600;
        }

        .nav-tabs {
            border-bottom: 2px solid #5a9;
        }

            .nav-tabs .nav-link {
                color: #666;
                font-weight: 500;
                border: none;
                padding: 0.75rem 1.5rem;
            }

                .nav-tabs .nav-link.active {
                    background: #5a9;
                    color: white;
                    border-radius: 8px 8px 0 0;
                }

        .badge {
            font-size: 0.9rem;
            padding: 0.4rem 0.8rem;
        }

        .table-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }

        .btn-back {
            background: #6b8e8e;
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 5px;
            text-decoration: none;
        }

            .btn-back:hover {
                background: #5a7d7d;
                color: white;
            }

        .nav-tabs .nav-item {
            min-width: 120px;
            text-align: center;
        }

        .nav-tabs .nav-link .badge {
            min-width: 28px;
            padding: 0.4em 0.6em;
            display: inline-block;
            white-space: nowrap;
            text-align: center;
        }

        /* 🔍 查詢按鈕 */
        .btn-search {
            background: linear-gradient(135deg, #4f7db8, #3a5f9b);
            color: #fff;
            border: none;
        }

            .btn-search:hover {
                background: linear-gradient(135deg, #3a5f9b, #2f4f85);
                color: #fff;
            }

        /* ✅ 已完成 */
        .badge-complete {
            background-color: #3f8f8b;
            color: #fff;
        }

        /* ⚠️ 睡前未測 */
        .badge-missing {
            background-color: #ffc445;
            color: #fff;
        }

        /* 🚨 上午＋睡前都未測 */
        .badge-danger-soft {
            background-color: #c84c4c;
            color: #fff;
        }

        /* 🌤 上午 */
        .badge-morning {
            background-color: #5fa8d3;
            color: #fff;
        }

        /* 🌙 睡前 */
        .badge-evening {
            background-color: #3b6ea5;
            color: #fff;
        }

        /* 📘 健康紀錄按鈕 */
        .btn-health {
            background: linear-gradient(135deg, #4fb3a2, #3a9d8f);
            color: #fff;
            border: none;
        }

            .btn-health:hover {
                background: linear-gradient(135deg, #3a9d8f, #2e7f73);
                color: #fff;
            }

        .badge {
            border-radius: 6px;
            font-weight: 500;
        }
        /* ===== 原因按鈕 ===== */
        .btn-reason {
            background: linear-gradient(135deg, #f6c343, #f0ad4e);
            border: none;
            color: #4a3b00;
            font-weight: 500;
            box-shadow: 0 2px 6px rgba(240, 173, 78, 0.35);
            transition: all 0.2s ease-in-out;
        }

            .btn-reason:hover {
                background: linear-gradient(135deg, #f0b429, #ec9c2b);
                color: #3a2e00;
                transform: translateY(-1px);
                box-shadow: 0 4px 10px rgba(240, 173, 78, 0.45);
            }

        /* ===== 原因 Modal 標題 ===== */
        .modal-header.reason-header {
            background: #f8f9fa;
            border-bottom: 1px solid #e0e6ed;
        }

            .modal-header.reason-header .modal-title {
                color: #2c3e50;
                font-weight: 600;
            }

        /* ===== 原因內容框 ===== */
        .reason-box {
            background: #fff8e1;
            border-left: 5px solid #f0ad4e;
            color: #5a4a00;
            padding: 0.75rem 1rem;
            border-radius: 0.4rem;
            font-size: 0.95rem;
            line-height: 1.6;
        }


    </style>

</head>
<body>
    <div class="main-container">
        <div class="page-header d-flex justify-content-between align-items-center">
            <h1 class="page-title"><i class="bi bi-clipboard-data"></i> 個案健康資訊填寫狀況</h1>
            <a href="@Url.Action("Dashboard", "Home")" class="btn-back">
                <i class="bi bi-arrow-left"></i> 返回主選單
            </a>
        </div>

        <div class="search-card">
            <form method="get" action="@Url.Action("MissedRecordsStatus")" class="row g-3">
                <div class="col-md-8">
                    <input type="text"
                           class="form-control"
                           name="searchIdNumber"
                           placeholder="輸入身分證字號查詢"
                           value="@ViewBag.SearchIdNumber">
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-search me-2">
                        <i class="bi bi-search"></i> 查詢
                    </button>
                    <a href="@Url.Action("MissedRecordsStatus")" class="btn btn-secondary">
                        <i class="bi bi-arrow-counterclockwise"></i> 清除
                    </a>
                </div>
            </form>
        </div>

        @* 🎯 查詢結果區塊：只要有查詢就顯示，不受 tab 影響 *@
        @if (hasSearch)
        {
            @if (searchResult != null)
            {
                <div class="search-result-card">
                    <div class="result-header mb-3">
                        <h5 class="mb-0"><i class="bi bi-search"></i> 查詢結果</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>未填天數</th>
                                    <th>姓名</th>
                                    <th>身分證字號</th>
                                    <th>生日</th>
                                    <th>性別</th>
                                    <th>電話</th>
                                    <th>上次填寫</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        @if (searchResult.MissedDays >= 999)
                                        {
                                            <span class="badge bg-secondary" style="font-size: 1rem; padding: 0.5rem 1rem;">從未填寫</span>
                                        }
                                        else if (searchResult.MissedDays >= 5)
                                        {
                                            <span class="badge bg-danger" style="font-size: 1rem; padding: 0.5rem 1rem;">@searchResult.MissedDays 天</span>
                                        }
                                        else if (searchResult.MissedDays >= 2)
                                        {
                                            <span class="badge bg-warning text-dark" style="font-size: 1rem; padding: 0.5rem 1rem;">@searchResult.MissedDays 天</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success" style="font-size: 1rem; padding: 0.5rem 1rem;">@searchResult.MissedDays 天</span>
                                        }
                                    </td>
                                    <td><strong>@searchResult.FullName</strong></td>
                                    <td>@searchResult.IDNumber</td>
                                    <td>@(searchResult.BirthDate == DateTime.MinValue ? "--" : searchResult.BirthDate.ToString("yyyy-MM-dd"))</td>
                                    <td>@(string.IsNullOrEmpty(searchResult.Gender) ? "--" : searchResult.Gender)</td>
                                    <td>@(string.IsNullOrEmpty(searchResult.PhoneNumber) ? "--" : searchResult.PhoneNumber)</td>
                                    <td>@(searchResult.LastRecordDate?.ToString("yyyy-MM-dd") ?? "從未填寫")</td>
                                    <td>
                                        <a href="@Url.Action("GetPatientRecords", "DailyHealth", new { idNumber = searchResult.IDNumber })"
                                           class="btn btn-primary btn-sm me-1">
                                            <i class="bi bi-clipboard-data"></i> 健康紀錄
                                        </a>

                                        @if (!string.IsNullOrEmpty(searchResult.MissedReason))
                                        {
                                            <button type="button"
                                                    class="btn btn-info btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#reasonModal"
                                                    onclick="showReason('@searchResult.FullName', '@searchResult.MissedReason')">
                                                <i class="bi bi-chat-square-text"></i> 查看原因
                                            </button>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">尚未回覆</span>
                                        }
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle"></i> 查無身分證字號「@ViewBag.SearchIdNumber」的個案資料
                </div>
            }
        }

        @* Tab 導航列 *@
        <ul class="nav nav-tabs mb-3" id="missedDaysTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "722" ? "active" : "")" id="days722-tab" type="button"
                        onclick="window.location.href='@Url.Action("MissedRecordsStatus", new { tab = "722", searchIdNumber = ViewBag.SearchIdNumber, checkDate = ViewBag.CheckDate })'">
                    需測量722血壓
                    <span class="badge @(count722Missing > 0 ? "bg-danger" : "bg-success")">@count722Missing</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "days2" ? "active" : "")" id="days2-tab" type="button"
                        onclick="window.location.href='@Url.Action("MissedRecordsStatus", new { tab = "days2", searchIdNumber = ViewBag.SearchIdNumber })'">
                    兩天未填 <span class="badge bg-warning text-dark">@countDays2</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "days3" ? "active" : "")" id="days3-tab" type="button"
                        onclick="window.location.href='@Url.Action("MissedRecordsStatus", new { tab = "days3", searchIdNumber = ViewBag.SearchIdNumber })'">
                    三天未填 <span class="badge bg-warning text-dark">@countDays3</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "days4" ? "active" : "")" id="days4-tab" type="button"
                        onclick="window.location.href='@Url.Action("MissedRecordsStatus", new { tab = "days4", searchIdNumber = ViewBag.SearchIdNumber })'">
                    四天未填 <span class="badge bg-warning text-dark">@countDays4</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "days5plus" ? "active" : "")" id="days5plus-tab" type="button"
                        onclick="window.location.href='@Url.Action("MissedRecordsStatus", new { tab = "days5plus", searchIdNumber = ViewBag.SearchIdNumber })'">
                    五天以上 <span class="badge bg-danger">@countDays5Plus</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "never" ? "active" : "")" id="never-tab" type="button"
                        onclick="window.location.href='@Url.Action("MissedRecordsStatus", new { tab = "never", searchIdNumber = ViewBag.SearchIdNumber })'">
                    從未填寫 <span class="badge bg-secondary">@countNever</span>
                </button>
            </li>
        </ul>

        @* 🎯 下方表格區塊：根據當前 tab 顯示對應資料 *@
        <div class="tab-content table-card" id="missedDaysTabContent">
            @if (activeTab == "722")
            {
                <div class="tab-pane fade show active" id="days722" role="tabpanel">
                    <h4 class="mb-3 text-primary">
                        <i class="bi bi-heart-pulse"></i> 需測量 722 血壓個案追蹤
                        <small class="text-muted fs-6 ms-3">檢查日期: @(((DateTime)ViewBag.CheckDate).ToString("yyyy-MM-dd"))</small>
                    </h4>
                    @if (trackingList.Any())
                    {
                        @await Html.PartialAsync("_722BPStatusTable", trackingList)
                    }
                    else
                    {
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i> 目前沒有需要測量 722 血壓的個案
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="tab-pane fade show active" id="missedDaysGeneral" role="tabpanel">
                    @if (Model.Any())
                    {
                        @await Html.PartialAsync("_MissedRecordsTable", Model)
                    }
                    else
                    {
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i> 目前沒有符合條件的個案
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <div class="modal fade" id="reasonModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-chat-square-text"></i> 未填寫原因
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>個案:</strong> <span id="modalPatientName"></span></p>
                    <p><strong>原因:</strong></p>
                    <div class="alert alert-info mb-0">
                        <span id="modalReason"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function showReason(patientName, reason) {
            document.getElementById('modalPatientName').textContent = patientName;
            document.getElementById('modalReason').textContent = reason;
        }
    </script>
</body>
</html>