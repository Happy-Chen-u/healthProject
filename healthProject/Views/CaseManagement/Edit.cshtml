@model CaseManagementViewModel
@{
    ViewData["Title"] = "編輯個案紀錄";
    Layout = null;

    bool isAnnualAssessment = Model.AnnualAssessment;
}

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #f0f4f8;
            padding: 20px;
            font-size: 13px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border: 2px solid #5a9;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .main-title {
            background: #5a9;
            color: white;
            text-align: center;
            padding: 12px;
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .patient-row {
            display: flex;
            border-bottom: 1px solid #bcd;
            background: #f8fdf9;
            flex-wrap: wrap;
        }

        .patient-cell {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border-right: 1px solid #cde;
            display: flex;
            align-items: center;
            gap: 8px;
        }

            .patient-cell:last-child {
                border-right: none;
            }

            .patient-cell strong {
                color: #357;
                white-space: nowrap;
            }

            .patient-cell span {
                font-weight: 500;
            }

            .patient-cell input, .patient-cell select {
                padding: 5px 8px;
                border: 1px solid #9cb;
                border-radius: 4px;
                font-size: 13px;
            }

            .patient-cell select {
                min-width: 80px;
            }

        .date-row {
            display: flex;
            border-bottom: 2px solid #5a9;
            background: #eef6f0;
            flex-wrap: wrap;
        }

        .date-cell {
            padding: 10px 20px;
            border-right: 1px solid #cde;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }

            .date-cell strong {
                color: #357;
            }

            .date-cell input[type="date"] {
                padding: 6px 10px;
                border: 1px solid #9cb;
                border-radius: 4px;
                font-size: 13px;
            }

        .record-type-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-first {
            background: #d4edda;
            color: #2a5a3a;
        }

        .badge-annual {
            background: #cce5ff;
            color: #004085;
        }

        .section-title {
            background: #5a9;
            color: white;
            padding: 8px 15px;
            font-weight: bold;
            font-size: 14px;
        }

        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }

        th, td {
            border: 1px solid #bcd;
            padding: 10px 8px;
            text-align: center;
            vertical-align: middle;
        }

        th {
            background: #e8f4ea;
            color: #2a5a3a;
            font-weight: 600;
            font-size: 12px;
            white-space: nowrap;
        }

        td {
            background: white;
            min-width: 100px;
        }

        input[type="text"], input[type="number"], input[type="date"], select, textarea {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #bcd;
            border-radius: 3px;
            font-size: 12px;
            text-align: center;
            font-family: inherit;
        }

        select {
            min-width: 90px;
        }

            input:focus, select:focus, textarea:focus {
                outline: none;
                border-color: #5a9;
                box-shadow: 0 0 0 2px rgba(85,170,153,0.2);
            }

        input[readonly] {
            background: #f5f5f5;
        }

        .multi-select {
            position: relative;
            min-width: 100px;
        }

        .multi-btn {
            width: 100%;
            min-height: 32px;
            padding: 6px 8px;
            border: 1px solid #bcd;
            border-radius: 3px;
            background: white;
            cursor: pointer;
            text-align: left;
            font-size: 11px;
        }

            .multi-btn:hover {
                border-color: #5a9;
            }

        .multi-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #bcd;
            border-radius: 3px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            min-width: 120px;
        }

            .multi-dropdown.show {
                display: block;
            }

        .multi-item {
            padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 12px;
        }

            .multi-item:hover {
                background: #e8f4ea;
            }

        .tag {
            display: inline-block;
            background: #d4edda;
            color: #2a5a3a;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 10px;
            margin: 1px;
        }

        .conditional-input {
            display: none;
            margin-top: 5px;
        }

            .conditional-input.show {
                display: block;
            }

        .quit-section {
            font-size: 11px;
            text-align: left;
            min-width: 160px;
        }

            .quit-section label {
                display: block;
                margin-bottom: 3px;
                color: #357;
                font-weight: 500;
            }

        .date-selects {
            display: flex;
            gap: 3px;
            align-items: center;
            margin-bottom: 8px;
        }

            .date-selects select {
                width: auto;
                min-width: 60px;
                padding: 3px 5px;
                font-size: 11px;
            }

            .date-selects span {
                font-size: 11px;
                color: #666;
            }

        .button-row {
            padding: 20px;
            text-align: center;
            background: #f8fdf9;
            border-top: 2px solid #5a9;
        }

        .btn {
            padding: 12px 35px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-save {
            background: #5a9;
            color: white;
        }

            .btn-save:hover {
                background: #4a8;
            }

        .btn-cancel {
            background: #8aa;
            color: white;
        }

            .btn-cancel:hover {
                background: #799;
                color: white;
                text-decoration: none;
            }

        .alert-info {
            background: #cce5ff;
            border: 1px solid #4a90a4;
            color: #004085;
            padding: 12px 20px;
            margin: 15px;
            border-radius: 5px;
            font-weight: 600;
        }

        @@media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .date-row {
                flex-direction: column;
            }

            .patient-cell {
                min-width: 100%;
            }

            .button-row {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .btn {
                width: 100%;
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-title">代謝症候群疾病管理紀錄表 - 編輯</div>

        <div class="alert-info">
            📝 編輯模式 - 個案: @Model.Name (@Model.IDNumber)
        </div>

        <form asp-action="Edit" method="post" id="editForm">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="UserId" />
            <input type="hidden" asp-for="IDNumber" />
            <input type="hidden" asp-for="Name" />
            <input type="hidden" asp-for="AnnualAssessment" />
            <input type="hidden" asp-for="AnnualAssessment_Date" />

            <!-- 用於 JavaScript 初始化的隱藏資料 -->
            <input type="hidden" id="initExerciseNone" value="@Model.ExerciseNone.ToString().ToLower()" />
            <input type="hidden" id="initExerciseUsually" value="@Model.ExerciseUsually.ToString().ToLower()" />
            <input type="hidden" id="initExerciseAlways" value="@Model.ExerciseAlways.ToString().ToLower()" />
            <input type="hidden" id="initSmokingNone" value="@Model.SmokingNone.ToString().ToLower()" />
            <input type="hidden" id="initSmokingUsually" value="@Model.SmokingUsually.ToString().ToLower()" />
            <input type="hidden" id="initSmokingUnder10" value="@Model.SmokingUnder10.ToString().ToLower()" />
            <input type="hidden" id="initSmokingOver10" value="@Model.SmokingOver10.ToString().ToLower()" />
            <input type="hidden" id="initBetelNutNone" value="@Model.BetelNutNone.ToString().ToLower()" />
            <input type="hidden" id="initBetelNutUsually" value="@Model.BetelNutUsually.ToString().ToLower()" />
            <input type="hidden" id="initBetelNutAlways" value="@Model.BetelNutAlways.ToString().ToLower()" />
            <input type="hidden" id="initBP722" value="@Model.BloodPressureGuidance722.ToString().ToLower()" />
            <input type="hidden" id="initSmokingServiceType1" value="@Model.SmokingServiceType1.ToString().ToLower()" />
            <input type="hidden" id="initSmokingServiceType2_Provide" value="@Model.SmokingServiceType2_Provide.ToString().ToLower()" />
            <input type="hidden" id="initCal1200" value="@Model.DailyCalories1200.ToString().ToLower()" />
            <input type="hidden" id="initCal1500" value="@Model.DailyCalories1500.ToString().ToLower()" />
            <input type="hidden" id="initCal1800" value="@Model.DailyCalories1800.ToString().ToLower()" />
            <input type="hidden" id="initCal2000" value="@Model.DailyCalories2000.ToString().ToLower()" />
            <input type="hidden" id="initCalOther" value="@Model.DailyCaloriesOther.ToString().ToLower()" />
            <input type="hidden" id="initExerciseGuidance" value="@Model.ExerciseGuidance.ToString().ToLower()" />
            <input type="hidden" id="initSocialResources" value="@Model.SocialExerciseResources.ToString().ToLower()" />
            <input type="hidden" id="initReduceFried" value="@Model.ReduceFriedFood.ToString().ToLower()" />
            <input type="hidden" id="initReduceSweet" value="@Model.ReduceSweetFood.ToString().ToLower()" />
            <input type="hidden" id="initReduceSalt" value="@Model.ReduceSalt.ToString().ToLower()" />
            <input type="hidden" id="initReduceSugar" value="@Model.ReduceSugaryDrinks.ToString().ToLower()" />
            <input type="hidden" id="initReduceOther" value="@Model.ReduceOther.ToString().ToLower()" />
            <input type="hidden" id="initCoronaryHigh" value="@Model.CoronaryHigh.ToString().ToLower()" />
            <input type="hidden" id="initCoronaryMedium" value="@Model.CoronaryMedium.ToString().ToLower()" />
            <input type="hidden" id="initCoronaryLow" value="@Model.CoronaryLow.ToString().ToLower()" />
            <input type="hidden" id="initCoronaryNA" value="@Model.CoronaryNotApplicable.ToString().ToLower()" />
            <input type="hidden" id="initDiabetesHigh" value="@Model.DiabetesHigh.ToString().ToLower()" />
            <input type="hidden" id="initDiabetesMedium" value="@Model.DiabetesMedium.ToString().ToLower()" />
            <input type="hidden" id="initDiabetesLow" value="@Model.DiabetesLow.ToString().ToLower()" />
            <input type="hidden" id="initDiabetesNA" value="@Model.DiabetesNotApplicabe.ToString().ToLower()" />
            <input type="hidden" id="initHypertensionHigh" value="@Model.HypertensionHigh.ToString().ToLower()" />
            <input type="hidden" id="initHypertensionMedium" value="@Model.HypertensionMedium.ToString().ToLower()" />
            <input type="hidden" id="initHypertensionLow" value="@Model.HypertensionLow.ToString().ToLower()" />
            <input type="hidden" id="initHypertensionNA" value="@Model.HypertensionNotApplicable.ToString().ToLower()" />
            <input type="hidden" id="initStrokeHigh" value="@Model.StrokeHigh.ToString().ToLower()" />
            <input type="hidden" id="initStrokeMedium" value="@Model.StrokeMedium.ToString().ToLower()" />
            <input type="hidden" id="initStrokeLow" value="@Model.StrokeLow.ToString().ToLower()" />
            <input type="hidden" id="initStrokeNA" value="@Model.StrokeNotApplicable.ToString().ToLower()" />
            <input type="hidden" id="initCardiovascularHigh" value="@Model.CardiovascularHigh.ToString().ToLower()" />
            <input type="hidden" id="initCardiovascularMedium" value="@Model.CardiovascularMedium.ToString().ToLower()" />
            <input type="hidden" id="initCardiovascularLow" value="@Model.CardiovascularLow.ToString().ToLower()" />
            <input type="hidden" id="initCardiovascularNA" value="@Model.CardiovascularNotApplicable.ToString().ToLower()" />

            <!-- 病患資訊列 -->
            <div class="patient-row">
                <div class="patient-cell"><strong>姓名：</strong><span>@Model.Name</span></div>
                <div class="patient-cell"><strong>身分證字號：</strong><span>@Model.IDNumber</span></div>
                <div class="patient-cell">
                    <strong>性別：</strong>
                    <select asp-for="Gender" id="selectGender">
                        <option value="">請選擇</option>
                        <option value="男">男</option>
                        <option value="女">女</option>
                    </select>
                </div>
                <div class="patient-cell">
                    <strong>生日：</strong>
                    <input asp-for="BirthDate" type="date" />
                </div>
            </div>

            <!-- 日期列 -->
            <div class="date-row">
                <div class="date-cell">
                    @if (isAnnualAssessment)
                    {
                        <span class="record-type-badge badge-annual">年度評估</span>
                        <strong>年度評估日期：</strong>
                    }
                    else
                    {
                        <span class="record-type-badge badge-first">收案評估</span>
                        <strong>收案評估日期：</strong>
                    }
                    <input asp-for="AssessmentDate" type="date" />
                </div>
                <div class="date-cell">
                    <strong>建議回診日期：</strong>
                    <input asp-for="FollowUpDate" type="date" />
                </div>
            </div>

            <!-- 評估指數 -->
            <div class="section-title">評估指數</div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>身高(公分)</th>
                            <th>體重(公斤)</th>
                            <th>BMI(kg/m²)</th>
                            <th>腰圍(公分)</th>
                            <th>運動</th>
                            <th>抽菸</th>
                            <th>嚼檳榔</th>
                            <th>飯前血糖值(mg/dL)</th>
                            <th>收縮壓(mmHg)</th>
                            <th>舒張壓(mmHg)</th>
                            <th>三酸甘油脂(mg/dL)</th>
                            <th>高密度脂蛋白膽固醇(mg/dL)</th>
                            <th>低密度脂蛋白膽固醇(mg/dL)</th>
                            <th>醣化血紅素(mg/dL)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input asp-for="Height" type="number" step="0.1" id="inputHeight" onchange="calcBMI()" /></td>
                            <td><input asp-for="Weight" type="number" step="0.1" id="inputWeight" onchange="calcBMI()" /></td>
                            <td>
                                <input type="text" id="displayBMI" value="@(Model.BMI_Value?.ToString("F1") ?? "")" readonly />
                                <input type="hidden" asp-for="BMI" id="hiddenBMI" />
                                <input type="hidden" asp-for="BMI_Value" id="hiddenBMI_Value" />
                            </td>
                            <td>
                                <input asp-for="CurrentWaist_Value" type="number" step="0.1" />
                                <input type="hidden" asp-for="CurrentWaist" value="true" />
                            </td>
                            <td>
                                <select id="selectExercise" onchange="updateExercise()">
                                    <option value="">請選擇</option>
                                    <option value="none">無</option>
                                    <option value="sometimes">偶爾</option>
                                    <option value="always">經常</option>
                                </select>
                                <input type="hidden" asp-for="ExerciseNone" id="exerciseNone" />
                                <input type="hidden" asp-for="ExerciseUsually" id="exerciseUsually" />
                                <input type="hidden" asp-for="ExerciseAlways" id="exerciseAlways" />
                            </td>
                            <td>
                                <select id="selectSmoking" onchange="updateSmoking()">
                                    <option value="">請選擇</option>
                                    <option value="none">無</option>
                                    <option value="sometimes">偶爾</option>
                                    <option value="under10">10支/日以下</option>
                                    <option value="over10">10支/日以上</option>
                                </select>
                                <input type="hidden" asp-for="SmokingNone" id="smokingNone" />
                                <input type="hidden" asp-for="SmokingUsually" id="smokingUsually" />
                                <input type="hidden" asp-for="SmokingUnder10" id="smokingUnder10" />
                                <input type="hidden" asp-for="SmokingOver10" id="smokingOver10" />
                            </td>
                            <td>
                                <select id="selectBetelNut" onchange="updateBetelNut()">
                                    <option value="">請選擇</option>
                                    <option value="none">無</option>
                                    <option value="sometimes">偶爾</option>
                                    <option value="always">經常</option>
                                </select>
                                <input type="hidden" asp-for="BetelNutNone" id="betelNutNone" />
                                <input type="hidden" asp-for="BetelNutUsually" id="betelNutUsually" />
                                <input type="hidden" asp-for="BetelNutAlways" id="betelNutAlways" />
                            </td>
                            <td>
                                <input asp-for="FastingGlucose_Value" type="number" />
                                <input type="hidden" asp-for="FastingGlucose" value="true" />
                            </td>
                            <td>
                                <input asp-for="SystolicBP_Value" type="number" />
                                <input type="hidden" asp-for="SystolicBP" value="true" />
                            </td>
                            <td>
                                <input asp-for="DiastolicBP_Value" type="number" />
                                <input type="hidden" asp-for="DiastolicBP" value="true" />
                            </td>
                            <td>
                                <input asp-for="Triglycerides_Value" type="number" />
                                <input type="hidden" asp-for="Triglycerides" value="true" />
                            </td>
                            <td>
                                <input asp-for="HDL_Value" type="number" />
                                <input type="hidden" asp-for="HDL" value="true" />
                            </td>
                            <td>
                                <input asp-for="LDL_Value" type="number" />
                                <input type="hidden" asp-for="LDL" value="true" />
                            </td>
                            <td>
                                <input asp-for="HbA1c_Value" type="number" step="0.1" />
                                <input type="hidden" asp-for="HbA1c" value="true" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 疾病管理指引 -->
            <div class="section-title">疾病管理指引</div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>是否需722血壓表</th>
                            <th>戒菸</th>
                            <th>戒檳</th>
                            <th>每日建議攝取熱量</th>
                            <th>盡量減少</th>
                            <th>運動建議</th>
                            <th>目標腰圍(cm)</th>
                            <th>目標體重(kg)</th>
                            <th>飯前血糖目標值</th>
                            <th>醣化血紅素目標值</th>
                            <th>三酸甘油脂目標值</th>
                            <th>高密度脂蛋白目標值</th>
                            <th>低密度脂蛋白目標值</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <select id="selectBP722" onchange="updateBP722()">
                                    <option value="">請選擇</option>
                                    <option value="yes">是</option>
                                    <option value="no">否</option>
                                </select>
                                <input type="hidden" asp-for="BloodPressureGuidance722" id="hiddenBP722" />
                            </td>
                            <td>
                                <select id="selectQuitSmoking" onchange="updateQuitSmoking()">
                                    <option value="">請選擇</option>
                                    <option value="guide">戒菸指導</option>
                                    <option value="provide">提供戒菸服務</option>
                                </select>
                                <input type="hidden" asp-for="SmokingService" id="smokingService" />
                                <input type="hidden" asp-for="SmokingServiceType1" id="smokingServiceType1" />
                                <input type="hidden" asp-for="SmokingServiceType2" id="smokingServiceType2" />
                                <input type="hidden" asp-for="SmokingServiceType2_Provide" id="smokingServiceType2_Provide" />
                                <input type="hidden" asp-for="SmokingServiceType2_Referral" id="smokingServiceType2_Referral" />
                            </td>
                            <td>
                                <div class="quit-section">
                                    <label>戒檳目標：</label>
                                    <div class="date-selects">
                                        <select asp-for="BetelQuitYear" id="quitYear">
                                            <option value="">年</option>
                                            @for (int y = DateTime.Now.Year; y <= DateTime.Now.Year + 5; y++)
                                            {
                                                <option value="@y">@y</option>
                                            }
                                        </select>
                                        <span>/</span>
                                        <select asp-for="BetelQuitMonth" id="quitMonth">
                                            <option value="">月</option>
                                            @for (int m = 1; m <= 12; m++)
                                            {
                                                <option value="@m">@m</option>
                                            }
                                        </select>
                                        <span>/</span>
                                        <select asp-for="BetelQuitDay" id="quitDay">
                                            <option value="">日</option>
                                            @for (int d = 1; d <= 31; d++)
                                            {
                                                <option value="@d">@d</option>
                                            }
                                        </select>
                                    </div>
                                    <label>口腔檢查：</label>
                                    <div class="date-selects">
                                        <select asp-for="OralExamYear" id="oralYear">
                                            <option value="">年</option>
                                            @for (int y = DateTime.Now.Year; y <= DateTime.Now.Year + 5; y++)
                                            {
                                                <option value="@y">@y</option>
                                            }
                                        </select>
                                        <span>/</span>
                                        <select asp-for="OralExamMonth" id="oralMonth">
                                            <option value="">月</option>
                                            @for (int m = 1; m <= 12; m++)
                                            {
                                                <option value="@m">@m</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                                <input type="hidden" asp-for="BetelNutService" id="betelNutService" />
                                <input type="hidden" asp-for="BetelQuitGoal" id="betelQuitGoal" />
                                <input type="hidden" asp-for="OralExam" id="oralExam" />
                            </td>
                            <td>
                                <select id="selectCalories" onchange="updateCalories()">
                                    <option value="">請選擇</option>
                                    <option value="1200">1200</option>
                                    <option value="1500">1500</option>
                                    <option value="1800">1800</option>
                                    <option value="2000">2000</option>
                                    <option value="other">其他</option>
                                </select>
                                <div class="conditional-input" id="caloriesOtherBox">
                                    <input asp-for="DailyCaloriesOtherValue" type="text" placeholder="輸入熱量" />
                                </div>
                                <input type="hidden" asp-for="DietManagement" id="dietManagement" />
                                <input type="hidden" asp-for="DailyCalories1200" id="cal1200" />
                                <input type="hidden" asp-for="DailyCalories1500" id="cal1500" />
                                <input type="hidden" asp-for="DailyCalories1800" id="cal1800" />
                                <input type="hidden" asp-for="DailyCalories2000" id="cal2000" />
                                <input type="hidden" asp-for="DailyCaloriesOther" id="calOther" />
                            </td>
                            <td>
                                <div class="multi-select">
                                    <div class="multi-btn" onclick="toggleDropdown('reduceDD')">
                                        <span id="reduceText">點擊複選...</span>
                                    </div>
                                    <div class="multi-dropdown" id="reduceDD">
                                        <div class="multi-item"><input type="checkbox" id="chkFried" onchange="updateReduce()" /><label for="chkFried">油炸物</label></div>
                                        <div class="multi-item"><input type="checkbox" id="chkSweet" onchange="updateReduce()" /><label for="chkSweet">甜食</label></div>
                                        <div class="multi-item"><input type="checkbox" id="chkSalt" onchange="updateReduce()" /><label for="chkSalt">鹽</label></div>
                                        <div class="multi-item"><input type="checkbox" id="chkSugar" onchange="updateReduce()" /><label for="chkSugar">含糖飲料</label></div>
                                        <div class="multi-item"><input type="checkbox" id="chkReduceOther" onchange="updateReduce()" /><label for="chkReduceOther">其他</label></div>
                                    </div>
                                </div>
                                <div class="conditional-input" id="reduceOtherBox">
                                    <input asp-for="ReduceOtherValue" type="text" placeholder="輸入其他" />
                                </div>
                                <input type="hidden" asp-for="ReduceFriedFood" id="reduceFried" />
                                <input type="hidden" asp-for="ReduceSweetFood" id="reduceSweet" />
                                <input type="hidden" asp-for="ReduceSalt" id="reduceSalt" />
                                <input type="hidden" asp-for="ReduceSugaryDrinks" id="reduceSugar" />
                                <input type="hidden" asp-for="ReduceOther" id="reduceOther" />
                            </td>
                            <td>
                                <select id="selectExerciseAdvice" onchange="updateExerciseAdvice()">
                                    <option value="">請選擇</option>
                                    <option value="guide">提供運動指導</option>
                                    <option value="resource">社區運動資源</option>
                                </select>
                                <div class="conditional-input" id="resourceBox">
                                    <input asp-for="SocialExerciseResources_Text" type="text" placeholder="輸入資源" />
                                </div>
                                <input type="hidden" asp-for="ExerciseRecommendation" id="exerciseRecommendation" />
                                <input type="hidden" asp-for="ExerciseGuidance" id="exerciseGuidance" />
                                <input type="hidden" asp-for="SocialExerciseResources" id="socialResources" />
                            </td>
                            <td>
                                <input asp-for="WaistTarget_Value" type="number" step="0.1" />
                                <input type="hidden" asp-for="Achievement" />
                            </td>
                            <td><input asp-for="WeightTarget_Value" type="number" step="0.1" /></td>
                            <td>
                                <input asp-for="FastingGlucoseTarget_Value" type="number" />
                                <input type="hidden" asp-for="FastingGlucoseTarget" />
                            </td>
                            <td>
                                <input asp-for="HbA1cTarget_Value" type="number" step="0.1" />
                                <input type="hidden" asp-for="HbA1cTarget" />
                                <input type="hidden" asp-for="HbA1c" value="true" />
                                <input type="hidden" asp-for="HbA1c_Value" />
                            </td>
                            <td>
                                <input asp-for="TriglyceridesTarget_Value" type="number" />
                                <input type="hidden" asp-for="TriglyceridesTarget" />
                            </td>
                            <td>
                                <input asp-for="HDL_CholesterolTarget_Value" type="number" />
                                <input type="hidden" asp-for="HDL_CholesterolTarget" />
                            </td>
                            <td>
                                <input asp-for="LDL_CholesterolTarget_Value" type="number" />
                                <input type="hidden" asp-for="LDL_CholesterolTarget" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 得到慢性病的風險 -->
            <div class="section-title">得到慢性病的風險</div>
            <div class="table-wrapper">
                <table style="min-width: 800px;">
                    <thead>
                        <tr>
                            <th style="width:20%">冠心病</th>
                            <th style="width:20%">糖尿病</th>
                            <th style="width:20%">高血壓</th>
                            <th style="width:20%">腦中風</th>
                            <th style="width:20%">心血管不良事件</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <select id="selectCoronary" onchange="updateCoronary()">
                                    <option value="">請選擇</option>
                                    <option value="high">高</option>
                                    <option value="medium">中</option>
                                    <option value="low">低</option>
                                    <option value="na">不適用</option>
                                </select>
                                <input type="hidden" asp-for="CoronaryHigh" id="coronaryHigh" />
                                <input type="hidden" asp-for="CoronaryMedium" id="coronaryMedium" />
                                <input type="hidden" asp-for="CoronaryLow" id="coronaryLow" />
                                <input type="hidden" asp-for="CoronaryNotApplicable" id="coronaryNA" />
                            </td>
                            <td>
                                <select id="selectDiabetes" onchange="updateDiabetes()">
                                    <option value="">請選擇</option>
                                    <option value="high">高</option>
                                    <option value="medium">中</option>
                                    <option value="low">低</option>
                                    <option value="na">不適用</option>
                                </select>
                                <input type="hidden" asp-for="DiabetesHigh" id="diabetesHigh" />
                                <input type="hidden" asp-for="DiabetesMedium" id="diabetesMedium" />
                                <input type="hidden" asp-for="DiabetesLow" id="diabetesLow" />
                                <input type="hidden" asp-for="DiabetesNotApplicabe" id="diabetesNA" />
                            </td>
                            <td>
                                <select id="selectHypertension" onchange="updateHypertension()">
                                    <option value="">請選擇</option>
                                    <option value="high">高</option>
                                    <option value="medium">中</option>
                                    <option value="low">低</option>
                                    <option value="na">不適用</option>
                                </select>
                                <input type="hidden" asp-for="HypertensionHigh" id="hypertensionHigh" />
                                <input type="hidden" asp-for="HypertensionMedium" id="hypertensionMedium" />
                                <input type="hidden" asp-for="HypertensionLow" id="hypertensionLow" />
                                <input type="hidden" asp-for="HypertensionNotApplicable" id="hypertensionNA" />
                            </td>
                            <td>
                                <select id="selectStroke" onchange="updateStroke()">
                                    <option value="">請選擇</option>
                                    <option value="high">高</option>
                                    <option value="medium">中</option>
                                    <option value="low">低</option>
                                    <option value="na">不適用</option>
                                </select>
                                <input type="hidden" asp-for="StrokeHigh" id="strokeHigh" />
                                <input type="hidden" asp-for="StrokeMedium" id="strokeMedium" />
                                <input type="hidden" asp-for="StrokeLow" id="strokeLow" />
                                <input type="hidden" asp-for="StrokeNotApplicable" id="strokeNA" />
                            </td>
                            <td>
                                <select id="selectCardiovascular" onchange="updateCardiovascular()">
                                    <option value="">請選擇</option>
                                    <option value="high">高</option>
                                    <option value="medium">中</option>
                                    <option value="low">低</option>
                                    <option value="na">不適用</option>
                                </select>
                                <input type="hidden" asp-for="CardiovascularHigh" id="cardiovascularHigh" />
                                <input type="hidden" asp-for="CardiovascularMedium" id="cardiovascularMedium" />
                                <input type="hidden" asp-for="CardiovascularLow" id="cardiovascularLow" />
                                <input type="hidden" asp-for="CardiovascularNotApplicable" id="cardiovascularNA" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 其他備註 -->
            <div class="section-title">其他備註</div>
            <div style="padding:15px;">
                <textarea asp-for="Notes" rows="3" placeholder="請輸入其他備註或提醒事項..." style="text-align:left;"></textarea>
                <input type="hidden" asp-for="OtherReminders" value="false" />
            </div>

            <!-- 按鈕 -->
            <div class="button-row">
                <a href="@Url.Action("Details", new { id = Model.Id })" class="btn btn-cancel">← 取消</a>
                <button type="submit" class="btn btn-save">✓ 儲存變更</button>
            </div>
        </form>
    </div>

    <script>
        // 頁面載入時初始化所有下拉選單的值
        document.addEventListener('DOMContentLoaded', function () {
            initializeSelects();
            initializeCheckboxes();
            updateReduce(); // 更新多選顯示文字
        });

        function initializeSelects() {
            // 運動
            if (document.getElementById('initExerciseNone').value === 'true') {
                document.getElementById('selectExercise').value = 'none';
            } else if (document.getElementById('initExerciseUsually').value === 'true') {
                document.getElementById('selectExercise').value = 'sometimes';
            } else if (document.getElementById('initExerciseAlways').value === 'true') {
                document.getElementById('selectExercise').value = 'always';
            }

            // 抽菸
            if (document.getElementById('initSmokingNone').value === 'true') {
                document.getElementById('selectSmoking').value = 'none';
            } else if (document.getElementById('initSmokingUsually').value === 'true') {
                document.getElementById('selectSmoking').value = 'sometimes';
            } else if (document.getElementById('initSmokingUnder10').value === 'true') {
                document.getElementById('selectSmoking').value = 'under10';
            } else if (document.getElementById('initSmokingOver10').value === 'true') {
                document.getElementById('selectSmoking').value = 'over10';
            }

            // 嚼檳榔
            if (document.getElementById('initBetelNutNone').value === 'true') {
                document.getElementById('selectBetelNut').value = 'none';
            } else if (document.getElementById('initBetelNutUsually').value === 'true') {
                document.getElementById('selectBetelNut').value = 'sometimes';
            } else if (document.getElementById('initBetelNutAlways').value === 'true') {
                document.getElementById('selectBetelNut').value = 'always';
            }

            // 722血壓表
            if (document.getElementById('initBP722').value === 'true') {
                document.getElementById('selectBP722').value = 'yes';
            } else {
                document.getElementById('selectBP722').value = 'no';
            }

            // 戒菸服務
            if (document.getElementById('initSmokingServiceType1').value === 'true') {
                document.getElementById('selectQuitSmoking').value = 'guide';
            } else if (document.getElementById('initSmokingServiceType2_Provide').value === 'true') {
                document.getElementById('selectQuitSmoking').value = 'provide';
            }

            // 每日熱量
            if (document.getElementById('initCal1200').value === 'true') {
                document.getElementById('selectCalories').value = '1200';
            } else if (document.getElementById('initCal1500').value === 'true') {
                document.getElementById('selectCalories').value = '1500';
            } else if (document.getElementById('initCal1800').value === 'true') {
                document.getElementById('selectCalories').value = '1800';
            } else if (document.getElementById('initCal2000').value === 'true') {
                document.getElementById('selectCalories').value = '2000';
            } else if (document.getElementById('initCalOther').value === 'true') {
                document.getElementById('selectCalories').value = 'other';
                document.getElementById('caloriesOtherBox').classList.add('show');
            }

            // 運動建議
            if (document.getElementById('initExerciseGuidance').value === 'true') {
                document.getElementById('selectExerciseAdvice').value = 'guide';
            } else if (document.getElementById('initSocialResources').value === 'true') {
                document.getElementById('selectExerciseAdvice').value = 'resource';
                document.getElementById('resourceBox').classList.add('show');
            }

            // 冠心病風險
            if (document.getElementById('initCoronaryHigh').value === 'true') {
                document.getElementById('selectCoronary').value = 'high';
            } else if (document.getElementById('initCoronaryMedium').value === 'true') {
                document.getElementById('selectCoronary').value = 'medium';
            } else if (document.getElementById('initCoronaryLow').value === 'true') {
                document.getElementById('selectCoronary').value = 'low';
            } else if (document.getElementById('initCoronaryNA').value === 'true') {
                document.getElementById('selectCoronary').value = 'na';
            }

            // 糖尿病風險
            if (document.getElementById('initDiabetesHigh').value === 'true') {
                document.getElementById('selectDiabetes').value = 'high';
            } else if (document.getElementById('initDiabetesMedium').value === 'true') {
                document.getElementById('selectDiabetes').value = 'medium';
            } else if (document.getElementById('initDiabetesLow').value === 'true') {
                document.getElementById('selectDiabetes').value = 'low';
            } else if (document.getElementById('initDiabetesNA').value === 'true') {
                document.getElementById('selectDiabetes').value = 'na';
            }

            // 高血壓風險
            if (document.getElementById('initHypertensionHigh').value === 'true') {
                document.getElementById('selectHypertension').value = 'high';
            } else if (document.getElementById('initHypertensionMedium').value === 'true') {
                document.getElementById('selectHypertension').value = 'medium';
            } else if (document.getElementById('initHypertensionLow').value === 'true') {
                document.getElementById('selectHypertension').value = 'low';
            } else if (document.getElementById('initHypertensionNA').value === 'true') {
                document.getElementById('selectHypertension').value = 'na';
            }

            // 腦中風風險
            if (document.getElementById('initStrokeHigh').value === 'true') {
                document.getElementById('selectStroke').value = 'high';
            } else if (document.getElementById('initStrokeMedium').value === 'true') {
                document.getElementById('selectStroke').value = 'medium';
            } else if (document.getElementById('initStrokeLow').value === 'true') {
                document.getElementById('selectStroke').value = 'low';
            } else if (document.getElementById('initStrokeNA').value === 'true') {
                document.getElementById('selectStroke').value = 'na';
            }

            // 心血管風險
            if (document.getElementById('initCardiovascularHigh').value === 'true') {
                document.getElementById('selectCardiovascular').value = 'high';
            } else if (document.getElementById('initCardiovascularMedium').value === 'true') {
                document.getElementById('selectCardiovascular').value = 'medium';
            } else if (document.getElementById('initCardiovascularLow').value === 'true') {
                document.getElementById('selectCardiovascular').value = 'low';
            } else if (document.getElementById('initCardiovascularNA').value === 'true') {
                document.getElementById('selectCardiovascular').value = 'na';
            }
        }

        function initializeCheckboxes() {
            // 盡量減少 checkbox
            document.getElementById('chkFried').checked = document.getElementById('initReduceFried').value === 'true';
            document.getElementById('chkSweet').checked = document.getElementById('initReduceSweet').value === 'true';
            document.getElementById('chkSalt').checked = document.getElementById('initReduceSalt').value === 'true';
            document.getElementById('chkSugar').checked = document.getElementById('initReduceSugar').value === 'true';
            document.getElementById('chkReduceOther').checked = document.getElementById('initReduceOther').value === 'true';

            if (document.getElementById('chkReduceOther').checked) {
                document.getElementById('reduceOtherBox').classList.add('show');
            }
        }

        // BMI 計算
        function calcBMI() {
            const h = parseFloat(document.getElementById('inputHeight').value);
            const w = parseFloat(document.getElementById('inputWeight').value);
            if (h > 0 && w > 0) {
                const bmi = w / Math.pow(h / 100, 2);
                document.getElementById('displayBMI').value = bmi.toFixed(1);
                document.getElementById('hiddenBMI').value = 'true';
                document.getElementById('hiddenBMI_Value').value = bmi.toFixed(1);
            }
        }

        // 下拉選單更新函數
        function updateExercise() {
            const v = document.getElementById('selectExercise').value;
            document.getElementById('exerciseNone').value = (v === 'none');
            document.getElementById('exerciseUsually').value = (v === 'sometimes');
            document.getElementById('exerciseAlways').value = (v === 'always');
        }

        function updateSmoking() {
            const v = document.getElementById('selectSmoking').value;
            document.getElementById('smokingNone').value = (v === 'none');
            document.getElementById('smokingUsually').value = (v === 'sometimes');
            document.getElementById('smokingUnder10').value = (v === 'under10');
            document.getElementById('smokingOver10').value = (v === 'over10');
        }

        function updateBetelNut() {
            const v = document.getElementById('selectBetelNut').value;
            document.getElementById('betelNutNone').value = (v === 'none');
            document.getElementById('betelNutUsually').value = (v === 'sometimes');
            document.getElementById('betelNutAlways').value = (v === 'always');
        }

        function updateBP722() {
            const v = document.getElementById('selectBP722').value;
            document.getElementById('hiddenBP722').value = (v === 'yes');
        }

        function updateQuitSmoking() {
            const v = document.getElementById('selectQuitSmoking').value;
            document.getElementById('smokingService').value = (v !== '');
            document.getElementById('smokingServiceType1').value = (v === 'guide');
            document.getElementById('smokingServiceType2').value = (v === 'provide');
            document.getElementById('smokingServiceType2_Provide').value = (v === 'provide');
            document.getElementById('smokingServiceType2_Referral').value = 'false';
        }

        function updateCalories() {
            const v = document.getElementById('selectCalories').value;
            document.getElementById('dietManagement').value = (v !== '');
            document.getElementById('cal1200').value = (v === '1200');
            document.getElementById('cal1500').value = (v === '1500');
            document.getElementById('cal1800').value = (v === '1800');
            document.getElementById('cal2000').value = (v === '2000');
            document.getElementById('calOther').value = (v === 'other');
            document.getElementById('caloriesOtherBox').classList.toggle('show', v === 'other');
        }

        function updateExerciseAdvice() {
            const v = document.getElementById('selectExerciseAdvice').value;
            document.getElementById('exerciseRecommendation').value = (v !== '');
            document.getElementById('exerciseGuidance').value = (v === 'guide');
            document.getElementById('socialResources').value = (v === 'resource');
            document.getElementById('resourceBox').classList.toggle('show', v === 'resource');
        }

        // 多選下拉
        function toggleDropdown(id) {
            document.getElementById(id).classList.toggle('show');
        }

        function updateReduce() {
            const items = [
                { id: 'chkFried', hidden: 'reduceFried', text: '油炸物' },
                { id: 'chkSweet', hidden: 'reduceSweet', text: '甜食' },
                { id: 'chkSalt', hidden: 'reduceSalt', text: '鹽' },
                { id: 'chkSugar', hidden: 'reduceSugar', text: '含糖飲料' },
                { id: 'chkReduceOther', hidden: 'reduceOther', text: '其他' }
            ];
            const selected = [];
            items.forEach(item => {
                const checked = document.getElementById(item.id).checked;
                document.getElementById(item.hidden).value = checked;
                if (checked) selected.push(item.text);
            });
            const el = document.getElementById('reduceText');
            el.innerHTML = selected.length === 0 ? '點擊複選...' : selected.map(t => `<span class="tag">${t}</span>`).join('');
            document.getElementById('reduceOtherBox').classList.toggle('show', document.getElementById('chkReduceOther').checked);
        }

        // 疾病風險更新
        function updateCoronary() {
            const v = document.getElementById('selectCoronary').value;
            document.getElementById('coronaryHigh').value = (v === 'high');
            document.getElementById('coronaryMedium').value = (v === 'medium');
            document.getElementById('coronaryLow').value = (v === 'low');
            document.getElementById('coronaryNA').value = (v === 'na');
        }

        function updateDiabetes() {
            const v = document.getElementById('selectDiabetes').value;
            document.getElementById('diabetesHigh').value = (v === 'high');
            document.getElementById('diabetesMedium').value = (v === 'medium');
            document.getElementById('diabetesLow').value = (v === 'low');
            document.getElementById('diabetesNA').value = (v === 'na');
        }

        function updateHypertension() {
            const v = document.getElementById('selectHypertension').value;
            document.getElementById('hypertensionHigh').value = (v === 'high');
            document.getElementById('hypertensionMedium').value = (v === 'medium');
            document.getElementById('hypertensionLow').value = (v === 'low');
            document.getElementById('hypertensionNA').value = (v === 'na');
        }

        function updateStroke() {
            const v = document.getElementById('selectStroke').value;
            document.getElementById('strokeHigh').value = (v === 'high');
            document.getElementById('strokeMedium').value = (v === 'medium');
            document.getElementById('strokeLow').value = (v === 'low');
            document.getElementById('strokeNA').value = (v === 'na');
        }

        function updateCardiovascular() {
            const v = document.getElementById('selectCardiovascular').value;
            document.getElementById('cardiovascularHigh').value = (v === 'high');
            document.getElementById('cardiovascularMedium').value = (v === 'medium');
            document.getElementById('cardiovascularLow').value = (v === 'low');
            document.getElementById('cardiovascularNA').value = (v === 'na');
        }

        // 點擊外部關閉下拉選單
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.multi-select')) {
                document.querySelectorAll('.multi-dropdown').forEach(d => d.classList.remove('show'));
            }
        });
    </script>
</body>
</html>