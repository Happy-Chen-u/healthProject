@model List<healthProject.Models.MissedRecordViewModel>
@using System

<div class="table-responsive">
    <table class="table table-hover table-bordered align-middle">
        <thead class="table-light">
            <tr>
                <th style="width:8%">姓名</th>
                <th style="width:10%">身分證字號</th>
                <th style="width:10%">生日</th>
                <th style="width:5%">性別</th>
                <th style="width:9%">電話</th>
                <th style="width:9%">上次填寫</th>
                <th style="width:18%">今日血壓回報狀態 (@DateTime.Today.ToString("MM/dd"))</th>
                <th style="width:16%">當日血壓值</th>
                <th style="width:15%">操作</th>
            </tr>
        </thead>
        <tbody>
            @if (!Model.Any())
            {
                <tr>
                    <td colspan="9" class="text-center text-muted">目前沒有正在追蹤 722 血壓的個案</td>
                </tr>
            }
            @foreach (var record in Model.OrderByDescending(r => r.IsBothMissing))
            {
                // 決定狀態顏色
                string statusBadgeClass = "badge-complete";
                string statusText = "已完成";

                if (record.IsBothMissing)
                {
                    statusBadgeClass = "badge-danger-soft";
                    statusText = "上午及睡前均未測";
                }
                else if (record.IsMorningMissing || record.IsEveningMissing)
                {
                    statusBadgeClass = "badge-missing";
                    statusText = (record.IsMorningMissing ? "上午未測" : "") +
                    (record.IsMorningMissing && record.IsEveningMissing ? " & " : "") +
                    (record.IsEveningMissing ? "睡前未測" : "");
                }
                else if (record.Is722Tracking)
                {
                    statusText = "已完成";
                }

                <tr>
                    <td><strong>@record.FullName</strong></td>
                    <td>@record.IDNumber</td>
                    <td>@(record.BirthDate == DateTime.MinValue ? "--" : record.BirthDate.ToString("yyyy-MM-dd"))</td>
                    <td>@record.Gender</td>
                    <td>@record.PhoneNumber</td>
                    <td>@(record.LastRecordDate?.ToString("yyyy-MM-dd") ?? "從未填寫")</td>
                    <td>
                        <span class="badge @statusBadgeClass fs-6">
                            @statusText
                        </span>
                    </td>
                    <td>
                        @* 顯示當日血壓值 *@
                        <div style="font-size: 0.9rem;">
                            @if (!string.IsNullOrEmpty(record.MorningBPDisplay) && record.MorningBPDisplay != "--")
                            {
                                <div class="mb-1">
                                    <span class="badge badge-morning me-1">上午</span>
                                    <strong>@record.MorningBPDisplay</strong>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(record.EveningBPDisplay) && record.EveningBPDisplay != "--")
                            {
                                <div>
                                    <span class="badge badge-evening me-1">睡前</span>
                                    <strong>@record.EveningBPDisplay</strong>
                                </div>
                            }
                            @if ((string.IsNullOrEmpty(record.MorningBPDisplay) || record.MorningBPDisplay == "--") &&
                           (string.IsNullOrEmpty(record.EveningBPDisplay) || record.EveningBPDisplay == "--"))
                            {
                                <span class="text-muted">尚無數值</span>
                            }
                        </div>
                    </td>
                    <td>
                        <a href="@Url.Action("GetPatientRecords", "DailyHealth", new { idNumber = record.IDNumber })"
                               class="btn btn-sm btn-health me-1" title="查看健康紀錄">
                            <i class="bi bi-file-medical"></i> 健康紀錄
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>