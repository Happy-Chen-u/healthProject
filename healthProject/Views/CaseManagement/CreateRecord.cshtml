@model CaseManagementViewModel
@{
    ViewData["Title"] = "代謝症候群疾病管理紀錄表";
    Layout = null;
}

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #f0f4f8;
            padding: 20px;
            font-size: 13px;
            color: #333;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border: 2px solid #5a9;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .main-title {
            background: #5a9;
            color: white;
            text-align: center;
            padding: 12px;
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 2px;
        }
        
        /* 搜尋區塊 */
        .search-section {
            background: #e8f4ea;
            padding: 15px 20px;
            border-bottom: 2px solid #5a9;
        }
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .search-title { color: #2a5a3a; font-weight: bold; }
        .btn-back {
            padding: 8px 16px;
            background: #6b8e8e;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 13px;
            cursor: pointer;
            text-decoration: none;
        }
        .btn-back:hover { background: #5a7d7d; color: white; }
        .search-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .search-input {
            flex: 1; min-width: 250px; padding: 10px 15px;
            border: 2px solid #5a9; border-radius: 5px; font-size: 14px;
        }
        .search-input:focus { outline: none; border-color: #3a7; box-shadow: 0 0 0 3px rgba(85,170,153,0.2); }
        .btn-search {
            padding: 10px 25px; background: #5a9; color: white;
            border: none; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer;
        }
        .btn-search:hover { background: #4a8; }
        
        /* 成功訊息 */
        .alert-success {
            background: #d4edda;
            border: 1px solid #5a9;
            color: #2a5a3a;
            padding: 12px 20px;
            border-radius: 5px;
            margin: 15px 20px;
            font-weight: 600;
            display: none;
        }
        
        .patient-found {
            display: none; margin-top: 15px; padding: 15px;
            background: #d4edda; border: 1px solid #5a9; border-radius: 8px;
        }
        .patient-found.show { display: block; }
        .patient-found-info { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .patient-found-text { color: #2a5a3a; font-weight: 600; font-size: 15px; }
        .patient-actions { display: flex; gap: 10px; }
        .btn-action {
            padding: 8px 20px; border: none; border-radius: 5px;
            font-size: 13px; font-weight: 600; cursor: pointer; text-decoration: none;
        }
        .btn-new { background: #5a9; color: white; }
        .btn-new:hover { background: #4a8; }
        .btn-history { background: #4a90a4; color: white; }
        .btn-history:hover { background: #3a7a94; text-decoration: none; color: white; }
        .patient-stats { display: flex; gap: 20px; margin-top: 10px; }
        .stat-item { background: white; padding: 8px 15px; border-radius: 5px; text-align: center; }
        .stat-label { font-size: 12px; color: #666; }
        .stat-value { font-size: 16px; font-weight: bold; color: #2a5a3a; }
        
        .form-section { display: none; }
        .form-section.show { display: block; }
        
        /* 病患資訊列 */
        .patient-row { display: flex; border-bottom: 1px solid #bcd; background: #f8fdf9; flex-wrap: wrap; }
        .patient-cell {
            flex: 1; min-width: 200px; padding: 10px 15px; border-right: 1px solid #cde;
            display: flex; align-items: center; gap: 8px;
        }
        .patient-cell:last-child { border-right: none; }
        .patient-cell strong { color: #357; white-space: nowrap; }
        .patient-cell span { font-weight: 500; }
        .patient-cell input, .patient-cell select {
            padding: 5px 8px; border: 1px solid #9cb; border-radius: 4px; font-size: 13px;
        }
        .patient-cell select { min-width: 80px; }
        
        /* 日期列 */
        .date-row { display: flex; border-bottom: 2px solid #5a9; background: #eef6f0; flex-wrap: wrap; }
        .date-cell {
            padding: 10px 20px; border-right: 1px solid #cde;
            display: flex; align-items: center; gap: 10px; white-space: nowrap;
        }
        .date-cell strong { color: #357; }
        .date-cell input[type="date"] { padding: 6px 10px; border: 1px solid #9cb; border-radius: 4px; font-size: 13px; }
        .record-type-badge { padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; }
        .badge-first { background: #d4edda; color: #2a5a3a; }
        .badge-annual { background: #cce5ff; color: #004085; }
        
        /* 區塊標題 */
        .section-title { background: #5a9; color: white; padding: 8px 15px; font-weight: bold; font-size: 14px; }
        
        /* 表格容器 */
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        
        /* 表格 */
        table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        th, td { border: 1px solid #bcd; padding: 10px 8px; text-align: center; vertical-align: middle; }
        th { background: #e8f4ea; color: #2a5a3a; font-weight: 600; font-size: 12px; white-space: nowrap; }
        td { background: white; min-width: 100px; }
        
        input[type="text"], input[type="number"], input[type="date"], select, textarea {
            width: 100%; padding: 6px 8px; border: 1px solid #bcd; border-radius: 3px;
            font-size: 12px; text-align: center; font-family: inherit;
        }
        select { min-width: 90px; }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: #5a9; box-shadow: 0 0 0 2px rgba(85,170,153,0.2);
        }
        input[readonly] { background: #f5f5f5; }
        
        /* 多選下拉 */
        .multi-select { position: relative; min-width: 100px; }
        .multi-btn {
            width: 100%; min-height: 32px; padding: 6px 8px;
            border: 1px solid #bcd; border-radius: 3px; background: white;
            cursor: pointer; text-align: left; font-size: 11px;
        }
        .multi-btn:hover { border-color: #5a9; }
        .multi-dropdown {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #bcd; border-radius: 3px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; min-width: 120px;
        }
        .multi-dropdown.show { display: block; }
        .multi-item { padding: 8px 10px; display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px; }
        .multi-item:hover { background: #e8f4ea; }
        .tag { display: inline-block; background: #d4edda; color: #2a5a3a; padding: 2px 5px; border-radius: 3px; font-size: 10px; margin: 1px; }
        
        .conditional-input { display: none; margin-top: 5px; }
        .conditional-input.show { display: block; }
        
        /* 戒檳區塊 */
        .quit-section { font-size: 11px; text-align: left; min-width: 160px; }
        .quit-section label { display: block; margin-bottom: 3px; color: #357; font-weight: 500; }
        .date-selects { display: flex; gap: 3px; align-items: center; margin-bottom: 8px; }
        .date-selects select { width: auto; min-width: 60px; padding: 3px 5px; font-size: 11px; }
        .date-selects span { font-size: 11px; color: #666; }
        
        /* 按鈕區 */
        .button-row { padding: 20px; text-align: center; background: #f8fdf9; border-top: 2px solid #5a9; }
        .btn {
            padding: 12px 35px; margin: 0 10px; border: none; border-radius: 5px;
            font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-block;
        }
        .btn-save { background: #5a9; color: white; }
        .btn-save:hover { background: #4a8; }
        .btn-cancel { background: #8aa; color: white; }
        .btn-cancel:hover { background: #799; color: white; text-decoration: none; }

        @@media (max-width: 768px) {
            body { padding: 10px; }
            .search-row { flex-direction: column; }
            .search-input { width: 100%; }
            .patient-found-info { flex-direction: column; align-items: flex-start; }
            .patient-actions { width: 100%; flex-direction: column; }
            .btn-action { width: 100%; text-align: center; }
            .date-row { flex-direction: column; }
            .patient-cell { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-title">代謝症候群疾病管理紀錄表</div>
        
        <!-- 成功訊息 -->
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert-success" style="display:block;">
                ✅ @TempData["SuccessMessage"]
            </div>
        }
        
        <!-- 搜尋區塊 -->
        <div class="search-section">
            <div class="search-header">
                <div class="search-title">🔍 步驟 1：搜尋個案</div>
                <a href="@Url.Action("Index", "CaseManagement")" class="btn-back">← 回上一頁</a>
            </div>
            <div class="search-row">
                <input type="text" id="searchIdNumber" class="search-input" 
                       placeholder="請輸入個案身分證字號 (例如: A123456789)" maxlength="10" />
                <button type="button" class="btn-search" onclick="searchPatient()">🔍 搜尋個案</button>
            </div>
            
            <div id="patientFound" class="patient-found">
                <div class="patient-found-info">
                    <div class="patient-found-text" id="patientFoundText"></div>
                    <div class="patient-actions">
                        <button type="button" class="btn-action btn-new" onclick="showRecordForm()">➕ 新增本次評估紀錄</button>
                        <a href="#" id="btnViewHistory" class="btn-action btn-history">📚 查看歷史紀錄</a>
                    </div>
                </div>
                <div class="patient-stats">
                    <div class="stat-item">
                        <div class="stat-label">歷史紀錄數</div>
                        <div class="stat-value" id="recordCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">最近評估日期</div>
                        <div class="stat-value" id="lastRecord">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 表單區塊 -->
        <form asp-action="CreateRecord" method="post" id="recordForm" class="form-section">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="UserId" id="hiddenUserId" />
            <input type="hidden" asp-for="IDNumber" id="hiddenIDNumber" />
            <input type="hidden" asp-for="Name" id="hiddenName" />
            <input type="hidden" asp-for="Gender" id="hiddenGender" />
            <input type="hidden" asp-for="BirthDate" id="hiddenBirthDate" />
            <input type="hidden" asp-for="AnnualAssessment" id="hiddenAnnualAssessment" value="false" />
            <input type="hidden" asp-for="AnnualAssessment_Date" id="hiddenAnnualAssessmentDate" />
            
            <!-- 病患資訊列 -->
            <div class="patient-row">
                <div class="patient-cell"><strong>姓名：</strong><span id="displayName"></span></div>
                <div class="patient-cell"><strong>身分證字號：</strong><span id="displayIdNumber"></span></div>
                <div class="patient-cell" id="genderCell">
                    <strong>性別：</strong>
                    <span id="displayGenderText" style="display:none;"></span>
                    <select id="selectGender" onchange="document.getElementById('hiddenGender').value=this.value">
                        <option value="">請選擇</option>
                        <option value="男">男</option>
                        <option value="女">女</option>
                    </select>
                </div>
                <div class="patient-cell" id="birthCell">
                    <strong>生日：</strong>
                    <span id="displayBirthText" style="display:none;"></span>
                    <input type="date" id="inputBirthDate" onchange="document.getElementById('hiddenBirthDate').value=this.value" />
                </div>
            </div>
            
            <!-- 日期列 -->
            <div class="date-row">
                <div class="date-cell">
                    <span id="recordTypeBadge" class="record-type-badge badge-first">收案評估</span>
                    <strong id="dateTypeLabel">收案評估日期：</strong>
                    <input asp-for="AssessmentDate" type="date" id="assessmentDate" />
                </div>
                <div class="date-cell">
                    <strong>建議回診日期：</strong>
                    <input asp-for="FollowUpDate" type="date" />
                </div>
            </div>
            
            <!-- 評估指數 -->
            <div class="section-title">評估指數</div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>身高(公分)</th>
                            <th>體重(公斤)</th>
                            <th>BMI(kg/m²)</th>
                            <th>腰圍(公分)</th>
                            <th>運動</th>
                            <th>抽菸</th>
                            <th>嚼檳榔</th>
                            <th>飯前血糖值(mg/dL)</th>
                            <th>收縮壓(mmHg)</th>
                            <th>舒張壓(mmHg)</th>
                            <th>三酸甘油脂(mg/dL)</th>
                            <th>高密度脂蛋白膽固醇(mg/dL)</th>
                            <th>低密度脂蛋白膽固醇(mg/dL)</th>
                            <th>醣化血紅素(mg/dL)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input asp-for="Height" type="number" step="0.1" id="inputHeight" onchange="calcBMI()" /></td>
                            <td><input asp-for="Weight" type="number" step="0.1" id="inputWeight" onchange="calcBMI()" /></td>
                            <td>
                                <input type="text" id="displayBMI" readonly />
                                <input type="hidden" asp-for="BMI" id="hiddenBMI" />
                                <input type="hidden" asp-for="BMI_Value" id="hiddenBMI_Value" />
                            </td>
                            <td>
                                <input asp-for="CurrentWaist_Value" type="number" step="0.1" />
                                <input type="hidden" asp-for="CurrentWaist" value="true" />
                            </td>
                            <td>
                                <select id="selectExercise" onchange="updateExercise()">
                                    <option value="">請選擇</option>
                                    <option value="none">無</option>
                                    <option value="sometimes">偶爾</option>
                                    <option value="always">經常</option>
                                </select>
                                <input type="hidden" asp-for="ExerciseNone" id="exerciseNone" />
                                <input type="hidden" asp-for="ExerciseUsually" id="exerciseUsually" />
                                <input type="hidden" asp-for="ExerciseAlways" id="exerciseAlways" />
                            </td>
                            <td>
                                <select id="selectSmoking" onchange="updateSmoking()">
                                    <option value="">請選擇</option>
                                    <option value="none">無</option>
                                    <option value="sometimes">偶爾</option>
                                    <option value="under10">10支/日以下</option>
                                    <option value="over10">10支/日以上</option>
                                </select>
                                <input type="hidden" asp-for="SmokingNone" id="smokingNone" />
                                <input type="hidden" asp-for="SmokingUsually" id="smokingUsually" />
                                <input type="hidden" asp-for="SmokingUnder10" id="smokingUnder10" />
                                <input type="hidden" asp-for="SmokingOver10" id="smokingOver10" />
                            </td>
                            <td>
                                <select id="selectBetelNut" onchange="updateBetelNut()">
                                    <option value="">請選擇</option>
                                    <option value="none">無</option>
                                    <option value="sometimes">偶爾</option>
                                    <option value="always">經常</option>
                                </select>
                                <input type="hidden" asp-for="BetelNutNone" id="betelNutNone" />
                                <input type="hidden" asp-for="BetelNutUsually" id="betelNutUsually" />
                                <input type="hidden" asp-for="BetelNutAlways" id="betelNutAlways" />
                            </td>
                            <td>
                                <input asp-for="FastingGlucose_Value" type="number" />
                                <input type="hidden" asp-for="FastingGlucose" value="true" />
                            </td>
                            <td>
                                <input asp-for="SystolicBP_Value" type="number" />
                                <input type="hidden" asp-for="SystolicBP" value="true" />
                            </td>
                            <td>
                                <input asp-for="DiastolicBP_Value" type="number" />
                                <input type="hidden" asp-for="DiastolicBP" value="true" />
                            </td>
                            <td>
                                <input asp-for="Triglycerides_Value" type="number" />
                                <input type="hidden" asp-for="Triglycerides" value="true" />
                            </td>
                            <td>
                                <input asp-for="HDL_Value" type="number" />
                                <input type="hidden" asp-for="HDL" value="true" />
                            </td>
                            <td>
                                <input asp-for="LDL_Value" type="number" />
                                <input type="hidden" asp-for="LDL" value="true" />
                            </td>
                            <td>
                                <input asp-for="HbA1c_Value" type="number" step="0.1" />
                                <input type="hidden" asp-for="HbA1c" value="true" />
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 疾病管理指引 -->
            <div class="section-title">疾病管理指引</div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>是否需722血壓表</th>
                            <th>戒菸</th>
                            <th>戒檳</th>
                            <th>每日建議攝取熱量</th>
                            <th>盡量減少</th>
                            <th>運動建議</th>
                            <th>目標腰圍(cm)</th>
                            <th>目標體重(kg)</th>
                            <th>飯前血糖目標值</th>
                            <th>醣化血紅素目標值</th>
                            <th>三酸甘油脂目標值</th>
                            <th>高密度脂蛋白目標值</th>
                            <th>低密度脂蛋白目標值</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <select id="selectBP722" onchange="updateBP722()">
                                    <option value="">請選擇</option>
                                    <option value="yes">是</option>
                                    <option value="no">否</option>
                                </select>
                                <input type="hidden" asp-for="BloodPressureGuidance722" id="hiddenBP722" />
                            </td>
                            <td>
                                <select id="selectQuitSmoking" onchange="updateQuitSmoking()">
                                    <option value="">請選擇</option>
                                    <option value="guide">戒菸指導</option>
                                    <option value="provide">提供戒菸服務</option>
                                </select>
                                <input type="hidden" asp-for="SmokingService" id="smokingService" />
                                <input type="hidden" asp-for="SmokingServiceType1" id="smokingServiceType1" />
                                <input type="hidden" asp-for="SmokingServiceType2" id="smokingServiceType2" />
                                <input type="hidden" asp-for="SmokingServiceType2_Provide" id="smokingServiceType2_Provide" />
                                <input type="hidden" asp-for="SmokingServiceType2_Referral" id="smokingServiceType2_Referral" />
                            </td>
                            <td>
                                <div class="quit-section">
                                    <label>戒檳目標：</label>
                                    <div class="date-selects">
                                        <select asp-for="BetelQuitYear" id="quitYear">
                                            <option value="">年</option>
                                            @for (int y = DateTime.Now.Year; y <= DateTime.Now.Year + 5; y++)
                                            {
                                                <option value="@y">@y</option>
                                            }
                                        </select>
                                        <span>/</span>
                                        <select asp-for="BetelQuitMonth" id="quitMonth">
                                            <option value="">月</option>
                                            @for (int m = 1; m <= 12; m++)
                                            {
                                                <option value="@m">@m</option>
                                            }
                                        </select>
                                        <span>/</span>
                                        <select asp-for="BetelQuitDay" id="quitDay">
                                            <option value="">日</option>
                                            @for (int d = 1; d <= 31; d++)
                                            {
                                                <option value="@d">@d</option>
                                            }
                                        </select>
                                    </div>
                                    <label>口腔檢查：</label>
                                    <div class="date-selects">
                                        <select asp-for="OralExamYear" id="oralYear">
                                            <option value="">年</option>
                                            @for (int y = DateTime.Now.Year; y <= DateTime.Now.Year + 5; y++)
                                            {
                                                <option value="@y">@y</option>
                                            }
                                        </select>
                                        <span>/</span>
                                        <select asp-for="OralExamMonth" id="oralMonth">
                                            <option value="">月</option>
                                            @for (int m = 1; m <= 12; m++)
                                            {
                                                <option value="@m">@m</option>
                                            }
                                        </select>
                                    </div>
                                </div>
                                <input type="hidden" asp-for="BetelNutService" id="betelNutService" value="false" />
                                <input type="hidden" asp-for="BetelQuitGoal" id="betelQuitGoal" value="false" />
                                <input type="hidden" asp-for="OralExam" id="oralExam" value="false" />
                            </td>
                            <td>
                                <select id="selectCalories" onchange="updateCalories()">
                                    <option value="">請選擇</option>
                                    <option value="1200">1200</option>
                                    <option value="1500">1500</option>
                                    <option value="1800">1800</option>
                                    <option value="2000">2000</option>
                                    <option value="other">其他</option>
                                </select>
                                <div class="conditional-input" id="caloriesOtherBox">
                                    <input asp-for="DailyCaloriesOtherValue" type="text" placeholder="輸入熱量" />
                                </div>
                                <input type="hidden" asp-for="DietManagement" id="dietManagement" value="false" />
                                <input type="hidden" asp-for="DailyCalories1200" id="cal1200" />
                                <input type="hidden" asp-for="DailyCalories1500" id="cal1500" />
                                <input type="hidden" asp-for="DailyCalories1800" id="cal1800" />
                                <input type="hidden" asp-for="DailyCalories2000" id="cal2000" />
                                <input type="hidden" asp-for="DailyCaloriesOther" id="calOther" />
                            </td>
                            <td>
                                <div class="multi-select">
                                    <div class="multi-btn" onclick="toggleDropdown('reduceDD')">
                                        <span id="reduceText">點擊複選...</span>
                                    </div>
                                    <div class="multi-dropdown" id="reduceDD">
                                        <div class="multi-item"><input type="checkbox" id="chkFried" onchange="updateReduce()" /><label for="chkFried">油炸物</label></div>
                                        <div class="multi-item"><input type="checkbox" id="chkSweet" onchange="updateReduce()" /><label for="chkSweet">甜食</label></div>
                                        <div class="multi-item"><input type="checkbox" id="chkSalt" onchange="updateReduce()" /><label for="chkSalt">鹽</label></div>
                                        <div class="multi-item"><input type="checkbox" id="chkSugar" onchange="updateReduce()" /><label for="chkSugar">含糖飲料</label></div>
                                        <div class="multi-item"><input type="checkbox" id="chkReduceOther" onchange="updateReduce()" /><label for="chkReduceOther">其他</label></div>
                                    </div>
                                </div>
                                <div class="conditional-input" id="reduceOtherBox">
                                    <input asp-for="ReduceOtherValue" type="text" placeholder="輸入其他" />
                                </div>
                                <input type="hidden" asp-for="ReduceFriedFood" id="reduceFried" />
                                <input type="hidden" asp-for="ReduceSweetFood" id="reduceSweet" />
                                <input type="hidden" asp-for="ReduceSalt" id="reduceSalt" />
                                <input type="hidden" asp-for="ReduceSugaryDrinks" id="reduceSugar" />
                                <input type="hidden" asp-for="ReduceOther" id="reduceOther" />
                            </td>
                            <td>
                                <select id="selectExerciseAdvice" onchange="updateExerciseAdvice()">
                                    <option value="">請選擇</option>
                                    <option value="guide">提供運動指導</option>
                                    <option value="resource">社區運動資源</option>
                                </select>
                                <div class="conditional-input" id="resourceBox">
                                    <input asp-for="SocialExerciseResources_Text" type="text" placeholder="輸入資源" />
                                </div>
                                <input type="hidden" asp-for="ExerciseRecommendation" id="exerciseRecommendation" value="false" />
                                <input type="hidden" asp-for="ExerciseGuidance" id="exerciseGuidance" />
                                <input type="hidden" asp-for="SocialExerciseResources" id="socialResources" />
                            </td>
                            <td>
                                <input asp-for="WaistTarget_Value" type="number" step="0.1" />
                                <input type="hidden" asp-for="Achievement" id="achievement" value="false" />
                            </td>
                            <td><input asp-for="WeightTarget_Value" type="number" step="0.1" /></td>
                            <td>
                                <input asp-for="FastingGlucoseTarget_Value" type="number" />
                                <input type="hidden" asp-for="FastingGlucoseTarget" id="fastingGlucoseTarget" value="false" />
                            </td>
                            <td>
                                <input asp-for="HbA1cTarget_Value" type="number" step="0.1" />
                                <input type="hidden" asp-for="HbA1cTarget" id="hba1cTarget" value="false" />
                                <input type="hidden" asp-for="HbA1c" value="true" />
                                <input type="hidden" asp-for="HbA1c_Value" />
                            </td>
                            <td>
                                <input asp-for="TriglyceridesTarget_Value" type="number" />
                                <input type="hidden" asp-for="TriglyceridesTarget" id="triglyceridesTarget" value="false" />
                            </td>
                            <td>
                                <input asp-for="HDL_CholesterolTarget_Value" type="number" />
                                <input type="hidden" asp-for="HDL_CholesterolTarget" id="hdlCholesterolTarget" value="false" />
                            </td>
                            <td>
                                <input asp-for="LDL_CholesterolTarget_Value" type="number" />
                                <input type="hidden" asp-for="LDL_CholesterolTarget" id="ldlCholesterolTarget" value="false" />
                            </td>
                            
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 得到慢性病的風險 -->
            <div class="section-title">得到慢性病的風險</div>
            <div class="table-wrapper">
                <table style="min-width: 800px;">
                    <thead>
                        <tr>
                            <th style="width:20%">冠心病</th>
                            <th style="width:20%">糖尿病</th>
                            <th style="width:20%">高血壓</th>
                            <th style="width:20%">腦中風</th>
                            <th style="width:20%">心血管不良事件</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <select id="selectCoronary" onchange="updateCoronary()">
                                    <option value="">請選擇</option>
                                    <option value="high">高</option>
                                    <option value="medium">中</option>
                                    <option value="low">低</option>
                                    <option value="na">不適用</option>
                                </select>
                                <input type="hidden" asp-for="CoronaryHigh" id="coronaryHigh" />
                                <input type="hidden" asp-for="CoronaryMedium" id="coronaryMedium" />
                                <input type="hidden" asp-for="CoronaryLow" id="coronaryLow" />
                                <input type="hidden" asp-for="CoronaryNotApplicable" id="coronaryNA" />
                            </td>
                            <td>
                                <select id="selectDiabetes" onchange="updateDiabetes()">
                                    <option value="">請選擇</option>
                                    <option value="high">高</option>
                                    <option value="medium">中</option>
                                    <option value="low">低</option>
                                    <option value="na">不適用</option>
                                </select>
                                <input type="hidden" asp-for="DiabetesHigh" id="diabetesHigh" />
                                <input type="hidden" asp-for="DiabetesMedium" id="diabetesMedium" />
                                <input type="hidden" asp-for="DiabetesLow" id="diabetesLow" />
                                <input type="hidden" asp-for="DiabetesNotApplicabe" id="diabetesNA" />
                            </td>
                            <td>
                                <select id="selectHypertension" onchange="updateHypertension()">
                                    <option value="">請選擇</option>
                                    <option value="high">高</option>
                                    <option value="medium">中</option>
                                    <option value="low">低</option>
                                    <option value="na">不適用</option>
                                </select>
                                <input type="hidden" asp-for="HypertensionHigh" id="hypertensionHigh" />
                                <input type="hidden" asp-for="HypertensionMedium" id="hypertensionMedium" />
                                <input type="hidden" asp-for="HypertensionLow" id="hypertensionLow" />
                                <input type="hidden" asp-for="HypertensionNotApplicable" id="hypertensionNA" />
                            </td>
                            <td>
                                <select id="selectStroke" onchange="updateStroke()">
                                    <option value="">請選擇</option>
                                    <option value="high">高</option>
                                    <option value="medium">中</option>
                                    <option value="low">低</option>
                                    <option value="na">不適用</option>
                                </select>
                                <input type="hidden" asp-for="StrokeHigh" id="strokeHigh" />
                                <input type="hidden" asp-for="StrokeMedium" id="strokeMedium" />
                                <input type="hidden" asp-for="StrokeLow" id="strokeLow" />
                                <input type="hidden" asp-for="StrokeNotApplicable" id="strokeNA" />
                            </td>
                            <td>
                                <select id="selectCardiovascular" onchange="updateCardiovascular()">
                                    <option value="">請選擇</option>
                                    <option value="high">高</option>
                                    <option value="medium">中</option>
                                    <option value="low">低</option>
                                    <option value="na">不適用</option>
                                </select>
                                <input type="hidden" asp-for="CardiovascularHigh" id="cardiovascularHigh" />
                                <input type="hidden" asp-for="CardiovascularMedium" id="cardiovascularMedium" />
                                <input type="hidden" asp-for="CardiovascularLow" id="cardiovascularLow" />
                                <input type="hidden" asp-for="CardiovascularNotApplicable" id="cardiovascularNA" />
                            </td>
                            
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 其他備註 -->
            <div class="section-title">其他備註</div>
            <div style="padding:15px;">
                <textarea asp-for="Notes" rows="3" placeholder="請輸入其他備註或提醒事項..." style="text-align:left;"></textarea>
                <input type="hidden" asp-for="OtherReminders" value="false" />
            </div>

            <!-- 按鈕 -->
            <div class="button-row">
                <button type="button" class="btn btn-cancel" onclick="cancelForm()">← 取消</button>
                <button type="submit" class="btn btn-save">✓ 儲存紀錄</button>
            </div>
        </form>
    </div>

    <script>
        let currentPatientId = null;
        let currentPatientIdNumber = null;
        let currentPatientName = null;
        let currentRecordCount = 0;
        let previousGender = '';
        let previousBirthDate = '';

        // 搜尋病患
        async function searchPatient() {
            const idNumber = document.getElementById('searchIdNumber').value.trim();
            if (!idNumber) { alert('請輸入身分證字號'); return; }

            try {
                const response = await fetch('@Url.Action("SearchPatient", "CaseManagement")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({ idNumber: idNumber })
                });
                const result = await response.json();

                if (result.success) {
                    currentPatientId = result.data.id;
                    currentPatientIdNumber = result.data.idNumber;
                    currentPatientName = result.data.name;
                    currentRecordCount = result.data.recordCount || 0;

                    document.getElementById('patientFoundText').innerHTML = `✅ 找到個案: ${result.data.name} (${result.data.idNumber})`;
                    document.getElementById('patientFound').classList.add('show');
                    document.getElementById('recordCount').innerText = currentRecordCount;
                    document.getElementById('lastRecord').innerText = result.data.lastRecordDate || '--';
                    document.getElementById('btnViewHistory').href = `@Url.Action("ViewAllRecords", "CaseManagement")?searchIdNumber=${result.data.idNumber}`;
                    document.getElementById('recordForm').classList.remove('show');

                    // 如果有歷史紀錄，取得上次的性別和生日
                    if (currentRecordCount > 0) {
                        await fetchPreviousData(idNumber);
                    }
                } else {
                    alert(result.message || '查無此個案');
                    document.getElementById('patientFound').classList.remove('show');
                    document.getElementById('recordForm').classList.remove('show');
                }
            } catch (error) {
                console.error('搜尋失敗:', error);
                alert('搜尋失敗，請稍後再試');
            }
        }

        // 取得上次紀錄的性別和生日
        async function fetchPreviousData(idNumber) {
            try {
                const response = await fetch(`@Url.Action("GetLatestPatientData", "CaseManagement")?idNumber=${idNumber}`);
                const result = await response.json();
                if (result.success && result.data) {
                    previousGender = result.data.gender || '';
                    previousBirthDate = result.data.birthDate || '';
                }
            } catch (error) {
                console.error('取得歷史資料失敗:', error);
            }
        }

        // 顯示表單
        // 顯示表單
        function showRecordForm() {
            if (!currentPatientId || !currentPatientIdNumber) { alert('請先搜尋個案'); return; }

            // 填入基本資料
            document.getElementById('hiddenUserId').value = currentPatientId;
            document.getElementById('hiddenIDNumber').value = currentPatientIdNumber;
            document.getElementById('hiddenName').value = currentPatientName;
            document.getElementById('displayName').innerText = currentPatientName;
            document.getElementById('displayIdNumber').innerText = currentPatientIdNumber;

            const dateLabel = document.getElementById('dateTypeLabel');
            const badge = document.getElementById('recordTypeBadge');
            const today = new Date().toISOString().split('T')[0];

            const genderSelect = document.getElementById('selectGender');
            const genderText = document.getElementById('displayGenderText');
            const birthInput = document.getElementById('inputBirthDate');
            const birthText = document.getElementById('displayBirthText');

            // 🆕 自動從身分證字號判斷性別
            let autoGender = '';
            if (currentPatientIdNumber && currentPatientIdNumber.length >= 2) {
                const secondChar = currentPatientIdNumber.charAt(1);
                if (secondChar === '1') {
                    autoGender = '男';
                } else if (secondChar === '2') {
                    autoGender = '女';
                }
            }

            if (currentRecordCount === 0) {
                // 首次收案評估
                dateLabel.innerText = '收案評估日期：';
                badge.innerText = '收案評估';
                badge.className = 'record-type-badge badge-first';
                document.getElementById('hiddenAnnualAssessment').value = 'false';

                // 🆕 性別 - 自動填入但允許修改
                genderSelect.style.display = 'inline-block';
                genderText.style.display = 'none';
                genderSelect.value = autoGender; // 自動選擇性別
                document.getElementById('hiddenGender').value = autoGender; // 同步更新 hidden 欄位

                // 生日 - 需要手動輸入
                birthInput.style.display = 'inline-block';
                birthText.style.display = 'none';
                birthInput.value = '';
            } else {
                // 年度評估 - 自動匯入
                dateLabel.innerText = '年度評估日期：';
                badge.innerText = '年度評估';
                badge.className = 'record-type-badge badge-annual';
                document.getElementById('hiddenAnnualAssessment').value = 'true';
                document.getElementById('hiddenAnnualAssessmentDate').value = today;

                // 性別 - 使用歷史資料或自動判斷
                genderSelect.style.display = 'none';
                genderText.style.display = 'inline';
                const displayGender = previousGender || autoGender || '--';
                genderText.innerText = displayGender;
                document.getElementById('hiddenGender').value = previousGender || autoGender;

                // 生日 - 使用歷史資料
                birthInput.style.display = 'none';
                birthText.style.display = 'inline';
                if (previousBirthDate) {
                    const bd = new Date(previousBirthDate);
                    birthText.innerText = `${bd.getFullYear()}/${(bd.getMonth() + 1).toString().padStart(2, '0')}/${bd.getDate().toString().padStart(2, '0')}`;
                } else {
                    birthText.innerText = '--';
                }
                document.getElementById('hiddenBirthDate').value = previousBirthDate;
            }

            document.getElementById('assessmentDate').value = today;
            document.getElementById('recordForm').classList.add('show');
            document.getElementById('recordForm').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelForm() {
            document.getElementById('recordForm').classList.remove('show');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // BMI 計算
        function calcBMI() {
            const h = parseFloat(document.getElementById('inputHeight').value);
            const w = parseFloat(document.getElementById('inputWeight').value);
            if (h > 0 && w > 0) {
                const bmi = w / Math.pow(h / 100, 2);
                document.getElementById('displayBMI').value = bmi.toFixed(1);
                document.getElementById('hiddenBMI').value = 'true';
                document.getElementById('hiddenBMI_Value').value = bmi.toFixed(1);
            }
        }

        // 下拉選單更新函數
        function updateExercise() {
            const v = document.getElementById('selectExercise').value;
            document.getElementById('exerciseNone').value = (v === 'none');
            document.getElementById('exerciseUsually').value = (v === 'sometimes');
            document.getElementById('exerciseAlways').value = (v === 'always');
        }

        function updateSmoking() {
            const v = document.getElementById('selectSmoking').value;
            document.getElementById('smokingNone').value = (v === 'none');
            document.getElementById('smokingUsually').value = (v === 'sometimes');
            document.getElementById('smokingUnder10').value = (v === 'under10');
            document.getElementById('smokingOver10').value = (v === 'over10');
        }

        function updateBetelNut() {
            const v = document.getElementById('selectBetelNut').value;
            document.getElementById('betelNutNone').value = (v === 'none');
            document.getElementById('betelNutUsually').value = (v === 'sometimes');
            document.getElementById('betelNutAlways').value = (v === 'always');
        }

        function updateBP722() {
            const v = document.getElementById('selectBP722').value;
            document.getElementById('hiddenBP722').value = (v === 'yes');
        }

        function updateQuitSmoking() {
            const v = document.getElementById('selectQuitSmoking').value;
            document.getElementById('smokingService').value = (v !== '');
            document.getElementById('smokingServiceType1').value = (v === 'guide');
            document.getElementById('smokingServiceType2').value = (v === 'provide');
            document.getElementById('smokingServiceType2_Provide').value = (v === 'provide');
            document.getElementById('smokingServiceType2_Referral').value = 'false';
        }

        function updateCalories() {
            const v = document.getElementById('selectCalories').value;
            document.getElementById('dietManagement').value = (v !== '');
            document.getElementById('cal1200').value = (v === '1200');
            document.getElementById('cal1500').value = (v === '1500');
            document.getElementById('cal1800').value = (v === '1800');
            document.getElementById('cal2000').value = (v === '2000');
            document.getElementById('calOther').value = (v === 'other');
            document.getElementById('caloriesOtherBox').classList.toggle('show', v === 'other');
        }

        function updateExerciseAdvice() {
            const v = document.getElementById('selectExerciseAdvice').value;
            document.getElementById('exerciseRecommendation').value = (v !== '');
            document.getElementById('exerciseGuidance').value = (v === 'guide');
            document.getElementById('socialResources').value = (v === 'resource');
            document.getElementById('resourceBox').classList.toggle('show', v === 'resource');
        }

        // 多選下拉
        function toggleDropdown(id) {
            document.getElementById(id).classList.toggle('show');
        }

        function updateReduce() {
            const items = [
                { id: 'chkFried', hidden: 'reduceFried', text: '油炸物' },
                { id: 'chkSweet', hidden: 'reduceSweet', text: '甜食' },
                { id: 'chkSalt', hidden: 'reduceSalt', text: '鹽' },
                { id: 'chkSugar', hidden: 'reduceSugar', text: '含糖飲料' },
                { id: 'chkReduceOther', hidden: 'reduceOther', text: '其他' }
            ];
            const selected = [];
            items.forEach(item => {
                const checked = document.getElementById(item.id).checked;
                document.getElementById(item.hidden).value = checked;
                if (checked) selected.push(item.text);
            });
            const el = document.getElementById('reduceText');
            el.innerHTML = selected.length === 0 ? '點擊複選...' : selected.map(t => `<span class="tag">${t}</span>`).join('');
            document.getElementById('reduceOtherBox').classList.toggle('show', document.getElementById('chkReduceOther').checked);
        }

        // 疾病風險更新
        function updateCoronary() {
            const v = document.getElementById('selectCoronary').value;
            document.getElementById('coronaryHigh').value = (v === 'high');
            document.getElementById('coronaryMedium').value = (v === 'medium');
            document.getElementById('coronaryLow').value = (v === 'low');
            document.getElementById('coronaryNA').value = (v === 'na');
        }

        function updateDiabetes() {
            const v = document.getElementById('selectDiabetes').value;
            document.getElementById('diabetesHigh').value = (v === 'high');
            document.getElementById('diabetesMedium').value = (v === 'medium');
            document.getElementById('diabetesLow').value = (v === 'low');
            document.getElementById('diabetesNA').value = (v === 'na');
        }

        function updateHypertension() {
            const v = document.getElementById('selectHypertension').value;
            document.getElementById('hypertensionHigh').value = (v === 'high');
            document.getElementById('hypertensionMedium').value = (v === 'medium');
            document.getElementById('hypertensionLow').value = (v === 'low');
            document.getElementById('hypertensionNA').value = (v === 'na');
        }

        function updateStroke() {
            const v = document.getElementById('selectStroke').value;
            document.getElementById('strokeHigh').value = (v === 'high');
            document.getElementById('strokeMedium').value = (v === 'medium');
            document.getElementById('strokeLow').value = (v === 'low');
            document.getElementById('strokeNA').value = (v === 'na');
        }

        function updateCardiovascular() {
            const v = document.getElementById('selectCardiovascular').value;
            document.getElementById('cardiovascularHigh').value = (v === 'high');
            document.getElementById('cardiovascularMedium').value = (v === 'medium');
            document.getElementById('cardiovascularLow').value = (v === 'low');
            document.getElementById('cardiovascularNA').value = (v === 'na');
        }

            

        // 點擊外部關閉下拉選單
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.multi-select')) {
                document.querySelectorAll('.multi-dropdown').forEach(d => d.classList.remove('show'));
            }
        });

        // Enter 鍵搜尋
        document.getElementById('searchIdNumber').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') { e.preventDefault(); searchPatient(); }
        });
    </script>
</body>
</html>