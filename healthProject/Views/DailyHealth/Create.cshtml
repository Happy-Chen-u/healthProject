@model HealthRecordViewModel
@{
    ViewData["Title"] = Model.Id > 0 ? "編輯健康紀錄" : "新增今日健康紀錄";
    Layout = null;
}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>@ViewData["Title"]</title>
</head>
<body>
<style>
    .form-container {
        max-width: 800px;
        margin: 1rem auto; 
        padding: 0 0.75rem; 
    }

    body {
        background-color: #e5eef5;
        font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
        min-height: 100vh;
        margin: 0;
        padding: 0;
    }

    .form-header {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        color: white;
        padding: 1.5rem 1rem;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
    }

    .form-header h1 {
        margin: 0;
        font-size: 1.5rem;
    }

    .form-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
    }

    .form-section {
        background: white;
        border-radius: 15px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #06b6d4;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 3px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    @@media (min-width: 768px) {
        .form-row {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .form-control, .form-select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 1rem;
        font-family: inherit;
        transition: all 0.3s ease;
        background-color: white;
        box-sizing: border-box;
    }

    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: #06b6d4;
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
    }

    /* 鎖定樣式 */
    .form-control:disabled, .form-select:disabled {
        background-color: #f0f0f0;
        color: #94a3b8;
        cursor: not-allowed;
        border-color: #cbd5e1;
    }

    input[type="checkbox"]:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }

    .input-hint {
        font-size: 0.85rem;
        color: #64748b;
        margin-top: 0.25rem;
    }

    .bp-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .bp-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .bp-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #475569;
    }

    .meal-section {
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: 10px;
        margin-bottom: 1rem;
    }

    .meal-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #0891b2;
        margin-bottom: 1rem;
    }

    .button-group {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
    }

    .btn {
        padding: 1rem 2.5rem;
        border: none;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: flex; 
        align-items: center; 
        justify-content: center; 
        text-align: center; 
        gap: 0.5rem;
        box-sizing: border-box;
    }

    .btn-primary {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
    }

    .btn-secondary {
        background: #e2e8f0;
        color: #475569;
    }

    .btn-secondary:hover {
        background: #cbd5e1;
        text-decoration: none;
        color: #475569;
    }

    .alert-info {
        background: #E3F2FD;
        border: 2px solid #42A5F5;
        color: #1565C0;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .alert-danger {
        background: #ffebee;
        border: 2px solid #ef5350;
        color: #c62828;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
    }

    /* 鎖定提示訊息樣式 */
    .locked-notice {
        background: #FFF3E0;
        border: 2px solid #FF9800;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        color: #E65100;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    @@media (max-width: 768px) {
        body {
            font-size: 16px; 
        }

        .form-header h1{
            font-size: 1.5rem;
        }

        .section-title {
            font-size: 1.15rem;
        }

        .form-label {
            font-size: 1rem;
        }

        .form-control, .form-select {
            font-size: 1.05rem;
            padding: 0.85rem; 
        }

        .bp-grid,
        div[style*="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr))"] {
            grid-template-columns: 1fr !important;
        }

        .button-group {
            flex-direction: column;
            gap: 0.75rem;
        }

        .btn {
            width: 100%;
            justify-content: center;
            font-size: 1.05rem;
            text-align: center;
        }

        div[style*="background: linear-gradient(135deg, #FFF9C4"] {
            padding: 1rem !important;
        }

        div[style*="background: linear-gradient(135deg, #E1BEE7"] {
            padding: 1rem !important;
        }

        .meal-title {
            font-size: 1.15rem; 
        }
    }
</style>

<div class="form-container">
    <div class="form-header">
        <h1>📝 @ViewData["Title"]</h1>
        <p>@DateTime.Today.ToString("yyyy年MM月dd日")</p>
    </div>

    <form asp-action="@(Model.Id > 0 ? "Edit" : "Create")" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="UserId" />

        @if (TempData["InfoMessage"] != null)
        {
            <div class="alert-info">
                @TempData["InfoMessage"]
            </div>
        }

        @if (!ViewData.ModelState.IsValid)
        {
            <div class="alert-danger">
                <div asp-validation-summary="All"></div>
            </div>
        }

        @if (TempData["BPWarnings"] != null)
        {
            var bpMessages = TempData["BPWarnings"].ToString().Split('\n');
            var hasErrors = bpMessages.Any(m => m.StartsWith("🔴"));

            <div class="@(hasErrors ? "alert-danger" : "alert-info")">
                @foreach (var msg in bpMessages)
                {
                    <p style="margin: 0;">@msg</p>
                }
            </div>
        }

        <!-- 血壓測量區塊 -->
        <div class="form-section">
            <div class="section-title">
                <span>❤️</span>
                <span>血壓測量 (mmHg)</span>
            </div>

            <!--  鎖定提示訊息 - 移到血壓區塊內 -->
            @if (Model.IsMorningCompletedToday || Model.IsEveningCompletedToday)
            {
                <div class="locked-notice">
                    <span style="font-size: 1.2rem;">🔒</span>
                    <div>
                        @if (Model.IsMorningCompletedToday && Model.IsEveningCompletedToday)
                        {
                            <div>今日的上午血壓與睡前血壓已完成記錄，無法再次勾選「尚未測量」。</div>
                        }
                        else if (Model.IsMorningCompletedToday)
                        {
                            <div>今日的上午血壓已完成記錄，無法再次勾選「尚未測量」。</div>
                        }
                        else if (Model.IsEveningCompletedToday)
                        {
                            <div>今日的睡前血壓已完成記錄，無法再次勾選「尚未測量」。</div>
                        }
                        <div style="margin-top: 0.25rem; font-size: 0.9rem;">若要修改血壓數值，請前往「我的紀錄」頁面編輯。</div>
                    </div>
                </div>
            }

            <!-- 測量說明 -->
            <div style="background: #E3F2FD; border-left: 4px solid #1976D2; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <strong style="color: #1565C0;">📍 測量時間說明:</strong>
                <div style="margin-top: 0.5rem; color: #1976D2; font-size: 0.9rem;">
                    • <strong>上午</strong>: 起床後 1 小時內,早餐前<br>
                    • <strong>睡前</strong>: 睡覺前 1 小時內<br>
                    • 每次測量間隔 1-2 分鐘,取兩遍的平均值
                </div>
            </div>

            <!-- Hidden fields for checkboxes -->
            <input type="hidden" id="BP_Morning_NotMeasured" name="BP_Morning_NotMeasured" value="false" />
            <input type="hidden" id="BP_Evening_NotMeasured" name="BP_Evening_NotMeasured" value="false" />

            <!-- 第一次 (上午) -->
            <div style="background: linear-gradient(135deg, #FFF9C4 0%, #FFF59D 100%); padding: 1.5rem; border-radius: 15px; margin-bottom: 1.5rem; border: 2px solid #FBC02D;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.5rem;">🌅</span>
                        <h4 style="margin: 0; color: #F57C00; font-weight: 700;">第一次 (上午)</h4>
                    </div>
                    <!-- 尚未測量 checkbox - 根據完成狀態決定是否鎖定 -->
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.25rem;">

                            <label style="display: flex; align-items: center; gap: 0.5rem;
                                          cursor: @(Model.IsMorningCompletedToday ? "not-allowed" : "pointer");
                                          background: rgba(255,255,255,0.8);
                                          padding: 0.5rem 1rem;
                                          border-radius: 8px;
                                          border: 2px solid #FFB300;
                                          @(Model.IsMorningCompletedToday ? "opacity: 0.6;" : "")">

                                <input type="checkbox"
                                       id="morning_not_measured"
                                       onchange="toggleMorningBP(this.checked)"
                                       style="width: 18px; height: 18px;
                                              cursor: @(Model.IsMorningCompletedToday ? "not-allowed" : "pointer");"
                                       @(Model.IsMorningCompletedToday ? "disabled" : "")>

                                <span style="color: #E65100; font-weight: 600;">尚未測量</span>
                            </label>

                            @* 🔒 鎖定原因提示 *@
                            @if (Model.IsMorningCompletedToday)
                            {
                                <div style="font-size: 0.8rem; color: #BF360C; font-weight: 600; text-align: right;">
                                    已完成今日上午血壓，<br />
                                    若要修改請至「我的紀錄」
                                </div>
                            }
                        </div>
                </div>

                <!-- 第一遍 -->
                <div style="background: rgba(255, 255, 255, 0.7); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #FFB300;">
                    <div style="font-weight: 600; color: #E65100; margin-bottom: 0.75rem; font-size: 1.05rem;">
                        📍 第一遍
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 500; color: #E65100; margin-bottom: 0.5rem;">
                                收縮壓 (上壓)
                            </label>
                            <input asp-for="BP_First_1_Systolic" 
                                   type="number" 
                                   class="form-control morning-bp-input"
                                   placeholder="例: 120" 
                                   min="30" 
                                   max="250" 
                                   step="1"
                                   style="padding: 0.75rem; border: 2px solid #FFB300; border-radius: 10px; font-size: 1rem; text-align: center;" />
                            <span asp-validation-for="BP_First_1_Systolic" class="text-danger"></span>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; color: #E65100; margin-bottom: 0.5rem;">
                                舒張壓 (下壓)
                            </label>
                            <input asp-for="BP_First_1_Diastolic" 
                                   type="number" 
                                   class="form-control morning-bp-input"
                                   placeholder="例: 80" 
                                   min="10" 
                                   max="150" 
                                   step="1"
                                   style="padding: 0.75rem; border: 2px solid #FFB300; border-radius: 10px; font-size: 1rem; text-align: center;" />
                            <span asp-validation-for="BP_First_1_Diastolic" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- 第二遍 -->
                <div style="background: rgba(255, 255, 255, 0.7); padding: 1rem; border-radius: 10px; border: 2px solid #FFD54F;">
                    <div style="font-weight: 600; color: #E65100; margin-bottom: 0.75rem; font-size: 1.05rem;">
                        📍 第二遍
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 500; color: #E65100; margin-bottom: 0.5rem;">
                                收縮壓 (上壓)
                            </label>
                            <input asp-for="BP_First_2_Systolic" 
                                   type="number" 
                                   class="form-control morning-bp-input"
                                   placeholder="例: 118" 
                                   min="30" 
                                   max="250" 
                                   step="1"
                                   style="padding: 0.75rem; border: 2px solid #FFD54F; border-radius: 10px; font-size: 1rem; text-align: center;" />
                            <span asp-validation-for="BP_First_2_Systolic" class="text-danger"></span>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; color: #E65100; margin-bottom: 0.5rem;">
                                舒張壓 (下壓)
                            </label>
                            <input asp-for="BP_First_2_Diastolic" 
                                   type="number" 
                                   class="form-control morning-bp-input"
                                   placeholder="例: 78" 
                                   min="10" 
                                   max="150" 
                                   step="1"
                                   style="padding: 0.75rem; border: 2px solid #FFD54F; border-radius: 10px; font-size: 1rem; text-align: center;" />
                            <span asp-validation-for="BP_First_2_Diastolic" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 0.75rem; padding: 0.5rem; background: rgba(255, 255, 255, 0.8); border-radius: 8px; font-size: 0.85rem; color: #E65100;">
                    💡若填第一遍,請記得填第二遍
                </div>
            </div>

            <!-- 第二次 (睡前) -->
            <div style="background: linear-gradient(135deg, #E1BEE7 0%, #CE93D8 100%); padding: 1.5rem; border-radius: 15px; margin-bottom: 1rem; border: 2px solid #9C27B0;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.5rem;">🌙</span>
                        <h4 style="margin: 0; color: #6A1B9A; font-weight: 700;">第二次 (睡前)</h4>
                    </div>
                    <!-- 尚未測量 checkbox - 根據完成狀態決定是否鎖定 -->
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.25rem;">

                            <label style="display: flex; align-items: center; gap: 0.5rem;
                                          cursor: @(Model.IsEveningCompletedToday ? "not-allowed" : "pointer");
                                          background: rgba(255,255,255,0.8);
                                          padding: 0.5rem 1rem;
                                          border-radius: 8px;
                                          border: 2px solid #FFB300;
                                          @(Model.IsEveningCompletedToday ? "opacity: 0.6;" : "")">

                                <input type="checkbox"
                                       id="evening_not_measured"
                                       onchange="toggleEveningBP(this.checked)"
                                       style="width: 18px; height: 18px;
                                              cursor: @(Model.IsEveningCompletedToday ? "not-allowed" : "pointer");"
                                       @(Model.IsEveningCompletedToday ? "disabled" : "")>

                                <span style="color: #E65100; font-weight: 600;">尚未測量</span>
                            </label>

                            @* 🔒 睡前鎖定原因提示 *@
                            @if (Model.IsEveningCompletedToday)
                            {
                                <div style="font-size: 0.8rem; color: #6B21AB; font-weight: 600; text-align: right;">
                                    已完成今日睡前血壓，<br />
                                    若要修改請至「我的紀錄」
                                </div>
                            }
                        </div>
                </div>

                <!-- 第一遍 -->
                <div style="background: rgba(255, 255, 255, 0.7); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #AB47BC;">
                    <div style="font-weight: 600; color: #4A148C; margin-bottom: 0.75rem; font-size: 1.05rem;">
                        📍 第一遍
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 500; color: #4A148C; margin-bottom: 0.5rem;">
                                收縮壓 (上壓)
                            </label>
                            <input asp-for="BP_Second_1_Systolic" 
                                   type="number" 
                                   class="form-control evening-bp-input"
                                   placeholder="例: 115" 
                                   min="30" 
                                   max="250" 
                                   step="1"
                                   style="padding: 0.75rem; border: 2px solid #AB47BC; border-radius: 10px; font-size: 1rem; text-align: center;" />
                            <span asp-validation-for="BP_Second_1_Systolic" class="text-danger"></span>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; color: #4A148C; margin-bottom: 0.5rem;">
                                舒張壓 (下壓)
                            </label>
                            <input asp-for="BP_Second_1_Diastolic" 
                                   type="number" 
                                   class="form-control evening-bp-input"
                                   placeholder="例: 75" 
                                   min="10" 
                                   max="150" 
                                   step="1"
                                   style="padding: 0.75rem; border: 2px solid #AB47BC; border-radius: 10px; font-size: 1rem; text-align: center;" />
                            <span asp-validation-for="BP_Second_1_Diastolic" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- 第二遍 -->
                <div style="background: rgba(255, 255, 255, 0.7); padding: 1rem; border-radius: 10px; border: 2px solid #CE93D8;">
                    <div style="font-weight: 600; color: #4A148C; margin-bottom: 0.75rem; font-size: 1.05rem;">
                        📍 第二遍
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 500; color: #4A148C; margin-bottom: 0.5rem;">
                                收縮壓 (上壓)
                            </label>
                            <input asp-for="BP_Second_2_Systolic" 
                                   type="number" 
                                   class="form-control evening-bp-input"
                                   placeholder="例: 117" 
                                   min="30" 
                                   max="250" 
                                   step="1"
                                   style="padding: 0.75rem; border: 2px solid #CE93D8; border-radius: 10px; font-size: 1rem; text-align: center;" />
                            <span asp-validation-for="BP_Second_2_Systolic" class="text-danger"></span>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; color: #4A148C; margin-bottom: 0.5rem;">
                                舒張壓 (下壓)
                            </label>
                            <input asp-for="BP_Second_2_Diastolic" 
                                   type="number" 
                                   class="form-control evening-bp-input"
                                   placeholder="例: 77" 
                                   min="10" 
                                   max="150" 
                                   step="1"
                                   style="padding: 0.75rem; border: 2px solid #CE93D8; border-radius: 10px; font-size: 1rem; text-align: center;" />
                            <span asp-validation-for="BP_Second_2_Diastolic" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 0.75rem; padding: 0.5rem; background: rgba(255, 255, 255, 0.8); border-radius: 8px; font-size: 0.85rem; color: #4A148C;">
                    💡 若填第一遍,請記得填第二遍
                </div>
            </div>

            <!-- 總說明 -->
            <div class="input-hint" style="background: #F3E5F5; padding: 1rem; border-radius: 10px; border-left: 4px solid #9C27B0;">
                <strong style="color: #6A1B9A;">📋 血壓標準值:</strong>
                <ul style="margin: 0.5rem 0 0 1.5rem; color: #4A148C;">
                    <li>正常血壓: 收縮壓 &lt; 120 mmHg、舒張壓 &lt; 80 mmHg</li>
                    <li>高血壓前期: 收縮壓 120-139 mmHg 或 舒張壓 80-89 mmHg</li>
                    <li>高血壓: 收縮壓 ≥ 140 mmHg 或 舒張壓 ≥ 90 mmHg</li>
                </ul>
            </div>
        </div>

        <!-- 三餐選擇 -->
        <div class="form-section">
            <div class="section-title">
                <span>🍽️</span>
                <span>三餐攝取</span>
            </div>

            <!-- 早餐 -->
            <div class="meal-section">
                <div class="meal-title">🌅 早餐</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">蔬菜 (拳頭)</label>
                        <select class="form-select" id="breakfast-veg" name="Meals_Breakfast_Vegetables">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5</option>
                            <option value="0.75">0.75</option>
                            <option value="1">1</option>
                            <option value="1.3">1.3</option>
                            <option value="1.5">1.5</option>
                            <option value="2">2</option>
                            <option value="2.5">2.5</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">蛋白質 (拳頭)</label>
                        <select class="form-select" id="breakfast-protein" name="Meals_Breakfast_Protein">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5</option>
                            <option value="0.75">0.75</option>
                            <option value="1">1</option>
                            <option value="1.3">1.3</option>
                            <option value="1.5">1.5</option>
                            <option value="2">2</option>
                            <option value="2.5">2.5</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">澱粉 (拳頭)</label>
                        <select class="form-select" id="breakfast-carbs" name="Meals_Breakfast_Carbs">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5</option>
                            <option value="0.75">0.75</option>
                            <option value="1">1</option>
                            <option value="1.3">1.3</option>
                            <option value="1.5">1.5</option>
                            <option value="2">2</option>
                            <option value="2.5">2.5</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 午餐 -->
            <div class="meal-section">
                <div class="meal-title">☀️ 午餐</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">蔬菜 (拳頭)</label>
                        <select class="form-select" id="lunch-veg">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5</option>
                            <option value="0.75">0.75</option>
                            <option value="1">1</option>
                            <option value="1.3">1.3</option>
                            <option value="1.5">1.5</option>
                            <option value="2">2</option>
                            <option value="2.5">2.5</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">蛋白質 (拳頭)</label>
                        <select class="form-select" id="lunch-protein">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5</option>
                            <option value="0.75">0.75</option>
                            <option value="1">1</option>
                            <option value="1.3">1.3</option>
                            <option value="1.5">1.5</option>
                            <option value="2">2</option>
                            <option value="2.5">2.5</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">澱粉 (拳頭)</label>
                        <select class="form-select" id="lunch-carbs">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5</option>
                            <option value="0.75">0.75</option>
                            <option value="1">1</option>
                            <option value="1.3">1.3</option>
                            <option value="1.5">1.5</option>
                            <option value="2">2</option>
                            <option value="2.5">2.5</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 晚餐 -->
            <div class="meal-section">
                <div class="meal-title">🌙 晚餐</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">蔬菜 (拳頭)</label>
                        <select class="form-select" id="dinner-veg">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5</option>
                            <option value="0.75">0.75</option>
                            <option value="1">1</option>
                            <option value="1.3">1.3</option>
                            <option value="1.5">1.5</option>
                            <option value="2">2</option>
                            <option value="2.5">2.5</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">蛋白質 (拳頭)</label>
                        <select class="form-select" id="dinner-protein">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5</option>
                            <option value="0.75">0.75</option>
                            <option value="1">1</option>
                            <option value="1.3">1.3</option>
                            <option value="1.5">1.5</option>
                            <option value="2">2</option>
                            <option value="2.5">2.5</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">澱粉 (拳頭)</label>
                        <select class="form-select" id="dinner-carbs">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5</option>
                            <option value="0.75">0.75</option>
                            <option value="1">1</option>
                            <option value="1.3">1.3</option>
                            <option value="1.5">1.5</option>
                            <option value="2">2</option>
                            <option value="2.5">2.5</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Hidden fields for MealSelection JSON -->
            <input type="hidden" id="Meals_Breakfast_Json" name="Meals_Breakfast" />
            <input type="hidden" id="Meals_Lunch_Json" name="Meals_Lunch" />
            <input type="hidden" id="Meals_Dinner_Json" name="Meals_Dinner" />
        </div>

        <!-- 運動資訊 -->
        <div class="form-section">
            <div class="section-title">
                <span>🏃</span>
                <span>運動資訊</span>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" asp-for="ExerciseType">運動種類</label>
                    <input asp-for="ExerciseType" class="form-control" placeholder="例如：慢跑、游泳、騎腳踏車" />
                </div>
                <div class="form-group">
                    <label class="form-label" asp-for="ExerciseDuration">運動時間 (分鐘)</label>
                    <input asp-for="ExerciseDuration" type="number" step="0.1" class="form-control" placeholder="0" />
                    <div class="input-hint">建議每日運動至少 150 分鐘</div>
                </div>
            </div>
        </div>

        <!-- 飲食資訊 -->
        <div class="form-section">
            <div class="section-title">
                <span>💧</span>
                <span>飲品攝取</span>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" asp-for="WaterIntake">水分攝取 (ml)</label>
                    <input asp-for="WaterIntake" type="number" class="form-control" placeholder="0" />
                    <div class="input-hint">建議每日飲水 2000 ml</div>
                </div>
                <div class="form-group">
                    <label class="form-label" asp-for="Beverage">其他飲料</label>
                    <input asp-for="Beverage" class="form-control" placeholder="例如:咖啡、茶、果汁" />
                </div>
            </div>
        </div>

        <!-- 生活習慣 -->
        <div class="form-section">
            <div class="section-title">
                <span>🚬</span>
                <span>生活習慣</span>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" asp-for="Cigarettes">抽菸支數</label>
                    <input asp-for="Cigarettes" type="number" class="form-control" placeholder="0" />
                    <div class="input-hint">建議戒菸以維護健康</div>
                </div>
                <div class="form-group">
                    <label class="form-label" asp-for="BetelNut">嚼檳榔次數</label>
                    <input asp-for="BetelNut" type="number" class="form-control" placeholder="0" />
                    <div class="input-hint">建議戒除檳榔以維護健康</div>
                </div>
            </div>
        </div>

        <!-- 生理數值 -->
        <div class="form-section">
            <div class="section-title">
                <span>🩸</span>
                <span>血糖</span>
            </div>
            <div class="form-group">
                <label class="form-label" asp-for="BloodSugar">血糖 (mg/dL)</label>
                <input asp-for="BloodSugar" type="number" step="0.1" class="form-control" placeholder="0" />
                <div class="input-hint">正常值：70-99 mg/dL</div>
            </div>
        </div>

        <div class="button-group">
            <a href="@Url.Action("Index", "DailyHealth")" class="btn btn-secondary">
                ← 取消
            </a>
            <button type="submit" class="btn btn-primary" onclick="return prepareMealData()">
                @(Model.Id > 0 ? "💾 儲存修改" : "✓ 下一步")
            </button>
        </div>
    </form>
</div>

<script>
    // ----------------------------------------------------
    // 血壓鎖定/解鎖函數 (根據後端傳來的完成狀態)
    // ----------------------------------------------------
    
    // 判斷上午血壓是否已完成（從後端傳來）
    const isMorningCompleted = @Json.Serialize(Model.IsMorningCompletedToday);
    const isEveningCompleted = @Json.Serialize(Model.IsEveningCompletedToday);

    // 控制上午血壓輸入框的啟用/禁用
    function toggleMorningBP(checked) {
        const inputs = document.querySelectorAll('.morning-bp-input');
        inputs.forEach(input => {
            // 🔒 如果已完成，則無論 checkbox 狀態都鎖定
            if (isMorningCompleted) {
                input.disabled = true;
                input.style.backgroundColor = '#f0f0f0';
            } else {
                input.disabled = checked;
                if (checked) {
                    input.value = '';
                    input.style.backgroundColor = '#f0f0f0';
                } else {
                    if (!input.value) {
                        input.style.backgroundColor = 'white';
                    }
                }
            }
        });
        // 更新 hidden field
        document.getElementById('BP_Morning_NotMeasured').value = checked ? 'true' : 'false';
    }

    // 控制睡前血壓輸入框的啟用/禁用
    function toggleEveningBP(checked) {
        const inputs = document.querySelectorAll('.evening-bp-input');
        inputs.forEach(input => {
            // 🔒 如果已完成，則無論 checkbox 狀態都鎖定
            if (isEveningCompleted) {
                input.disabled = true;
                input.style.backgroundColor = '#f0f0f0';
            } else {
                input.disabled = checked;
                if (checked) {
                    input.value = '';
                    input.style.backgroundColor = '#f0f0f0';
                } else {
                    if (!input.value) {
                        input.style.backgroundColor = 'white';
                    }
                }
            }
        });
        // 更新 hidden field
        document.getElementById('BP_Evening_NotMeasured').value = checked ? 'true' : 'false';
    }

    // ----------------------------------------------------
    // 頁面載入與初始化邏輯
    // ----------------------------------------------------
    document.addEventListener('DOMContentLoaded', function() {
        // 限制只能輸入數字的函數
        const bpInputs = document.querySelectorAll('input[asp-for^="BP_"]');
        bpInputs.forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (!/[0-9]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'Tab') {
                    e.preventDefault();
                }
            });
            input.addEventListener('paste', function(e) {
                e.preventDefault();
                const pastedData = e.clipboardData.getData('text');
                if (/^\d+$/.test(pastedData)) {
                    this.value = pastedData;
                }
            });
        });

        const exerciseDurationInput = document.querySelector('input[asp-for="ExerciseDuration"]');
        if (exerciseDurationInput) {
            exerciseDurationInput.addEventListener('keypress', function(e) {
                if (!/[0-9.]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'Tab') {
                    e.preventDefault();
                }
                if (e.key === '.' && this.value.includes('.')) {
                    e.preventDefault();
                }
            });
        }
        
        const waterInput = document.querySelector('input[asp-for="WaterIntake"]');
        if (waterInput) {
             waterInput.addEventListener('keypress', function(e) {
                if (!/[0-9]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'Tab') {
                    e.preventDefault();
                }
            });
        }
        
        const cigarettesInput = document.querySelector('input[asp-for="Cigarettes"]');
        if (cigarettesInput) {
            cigarettesInput.addEventListener('keypress', function(e) {
                if (!/[0-9]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'Tab') {
                    e.preventDefault();
                }
            });
        }
        
        const betelNutInput = document.querySelector('input[asp-for="BetelNut"]');
        if (betelNutInput) {
            betelNutInput.addEventListener('keypress', function(e) {
                if (!/[0-9]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'Tab') {
                    e.preventDefault();
                }
            });
        }
        
        const bloodSugarInput = document.querySelector('input[asp-for="BloodSugar"]');
        if (bloodSugarInput) {
            bloodSugarInput.addEventListener('keypress', function(e) {
                if (!/[0-9.]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'Tab') {
                    e.preventDefault();
                }
                if (e.key === '.' && this.value.includes('.')) {
                    e.preventDefault();
                }
            });
        }

        // 恢復三餐選項
        function restoreMealSelection(selectId, value) {
            if (!value) return;
            const selectElement = document.getElementById(selectId);
            if (selectElement) {
                selectElement.value = value;
            }
        }

        // 恢復三餐數據
        @if (Model.Meals_Breakfast != null)
        {
            <text>
            const breakfast = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Meals_Breakfast));
            if (breakfast.Vegetables) restoreMealSelection('breakfast-veg', breakfast.Vegetables);
            if (breakfast.Protein) restoreMealSelection('breakfast-protein', breakfast.Protein);
            if (breakfast.Carbs) restoreMealSelection('breakfast-carbs', breakfast.Carbs);
            </text>
        }

        @if (Model.Meals_Lunch != null)
        {
            <text>
            const lunch = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Meals_Lunch));
            if (lunch.Vegetables) restoreMealSelection('lunch-veg', lunch.Vegetables);
            if (lunch.Protein) restoreMealSelection('lunch-protein', lunch.Protein);
            if (lunch.Carbs) restoreMealSelection('lunch-carbs', lunch.Carbs);
            </text>
        }

        @if (Model.Meals_Dinner != null)
        {
            <text>
            const dinner = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Meals_Dinner));
            if (dinner.Vegetables) restoreMealSelection('dinner-veg', dinner.Vegetables);
            if (dinner.Protein) restoreMealSelection('dinner-protein', dinner.Protein);
            if (dinner.Carbs) restoreMealSelection('dinner-carbs', dinner.Carbs);
            </text>
        }

        // 🔒 恢復上午血壓的 checkbox 和鎖定狀態
        const morningCheckbox = document.getElementById('morning_not_measured');
        if (morningCheckbox) {
            @if (Model.BP_Morning_NotMeasured.HasValue && Model.BP_Morning_NotMeasured.Value)
            {
                <text>
                morningCheckbox.checked = true;
                </text>
            }
            // 🔒 初始化：如果已完成則鎖定輸入框
            if (isMorningCompleted) {
                const inputs = document.querySelectorAll('.morning-bp-input');
                inputs.forEach(input => {
                    input.disabled = true;
                    input.style.backgroundColor = '#f0f0f0';
                });
            } else {
                toggleMorningBP(morningCheckbox.checked);
            }
        }

        // 🔒 恢復睡前血壓的 checkbox 和鎖定狀態
        const eveningCheckbox = document.getElementById('evening_not_measured');
        if (eveningCheckbox) {
            @if (Model.BP_Evening_NotMeasured.HasValue && Model.BP_Evening_NotMeasured.Value)
            {
                <text>
                eveningCheckbox.checked = true;
                </text>
            }
            // 🔒 初始化：如果已完成則鎖定輸入框
            if (isEveningCompleted) {
                const inputs = document.querySelectorAll('.evening-bp-input');
                inputs.forEach(input => {
                    input.disabled = true;
                    input.style.backgroundColor = '#f0f0f0';
                });
            } else {
                toggleEveningBP(eveningCheckbox.checked);
            }
        }
    });

    // ----------------------------------------------------
    // 提交前準備數據
    // ----------------------------------------------------
    function prepareMealData() {
        const serializeMeal = (vegId, proteinId, carbsId, hiddenId) => {
            const veg = document.getElementById(vegId)?.value;
            const protein = document.getElementById(proteinId)?.value;
            const carbs = document.getElementById(carbsId)?.value;

            if (veg || protein || carbs) {
                const meal = {
                    Vegetables: veg,
                    Protein: protein,
                    Carbs: carbs
                };
                document.getElementById(hiddenId).value = JSON.stringify(meal);
            } else {
                document.getElementById(hiddenId).value = '';
            }
        };

        serializeMeal('breakfast-veg', 'breakfast-protein', 'breakfast-carbs', 'Meals_Breakfast_Json');
        serializeMeal('lunch-veg', 'lunch-protein', 'lunch-carbs', 'Meals_Lunch_Json');
        serializeMeal('dinner-veg', 'dinner-protein', 'dinner-carbs', 'Meals_Dinner_Json');

        return true;
    }
</script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
</body>
</html>
