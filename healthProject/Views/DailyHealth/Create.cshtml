@model HealthRecordViewModel
@{
    ViewData["Title"] = Model.Id > 0 ? "編輯健康紀錄" : "新增今日健康紀錄";
    Layout = null;
}

<style>
    .form-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    body {
        background-color: #e5eef5;
        font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
        min-height: 100vh;
        margin: 0;
        padding: 0;
    }

    .form-header {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
    }

    .form-header h1 {
        margin: 0;
        font-size: 1.8rem;
    }

    .form-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
    }

    .form-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .section-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #06b6d4;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 3px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    @@media (min-width: 768px) {
        .form-row {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .form-control, .form-select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 1rem;
        font-family: inherit;
        transition: all 0.3s ease;
        background-color: white;
    }

    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: #06b6d4;
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
    }

    .input-hint {
        font-size: 0.85rem;
        color: #64748b;
        margin-top: 0.25rem;
    }

    .bp-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .bp-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .bp-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #475569;
    }

    .meal-section {
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: 10px;
        margin-bottom: 1rem;
    }

    .meal-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #0891b2;
        margin-bottom: 1rem;
    }

    .button-group {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
    }

    .btn {
        padding: 1rem 2.5rem;
        border: none;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
    }

    .btn-secondary {
        background: #e2e8f0;
        color: #475569;
    }

    .btn-secondary:hover {
        background: #cbd5e1;
        text-decoration: none;
        color: #475569;
    }

    .alert-info {
        background: #E3F2FD;
        border: 2px solid #42A5F5;
        color: #1565C0;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .alert-danger {
        background: #ffebee;
        border: 2px solid #ef5350;
        color: #c62828;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
    }

    @@media (max-width: 768px) {
        .bp-grid {
            grid-template-columns: 1fr;
        }
    }
</style>



<div class="form-container">
    <div class="form-header">
        <h1>📝 @ViewData["Title"]</h1>
        <p>@DateTime.Today.ToString("yyyy年MM月dd日")</p>
    </div>

    <form asp-action="@(Model.Id > 0 ? "Edit" : "Create")" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="UserId" />

        @if (TempData["InfoMessage"] != null)
        {
            <div class="alert-info">
                @TempData["InfoMessage"]
            </div>
        }

        @if (!ViewData.ModelState.IsValid)
        {
            <div class="alert-danger">
                <div asp-validation-summary="All"></div>
            </div>
        }

        <!-- 🆕 血壓 - 4 個 "120/80" 格式輸入框 -->
        <div class="form-section">
            <div class="section-title">
                <span>❤️</span>
                <span>血壓測量 (mmHg)</span>
            </div>
            <div class="bp-grid">
                <div class="bp-item">
                    <label class="bp-label">第一次第一遍</label>
                    <input asp-for="BP_First_1_Input" type="text" class="form-control" placeholder="例：120/80" />
                    <span asp-validation-for="BP_First_1_Input" class="text-danger"></span>
                </div>
                <div class="bp-item">
                    <label class="bp-label">第一次第二遍</label>
                    <input asp-for="BP_First_2_Input" type="text" class="form-control" placeholder="例：118/78" />
                    <span asp-validation-for="BP_First_2_Input" class="text-danger"></span>
                </div>
                <div class="bp-item">
                    <label class="bp-label">第二次第一遍</label>
                    <input asp-for="BP_Second_1_Input" type="text" class="form-control" placeholder="例：115/75" />
                    <span asp-validation-for="BP_Second_1_Input" class="text-danger"></span>
                </div>
                <div class="bp-item">
                    <label class="bp-label">第二次第二遍</label>
                    <input asp-for="BP_Second_2_Input" type="text" class="form-control" placeholder="例：117/77" />
                    <span asp-validation-for="BP_Second_2_Input" class="text-danger"></span>
                </div>
            </div>
            <div class="input-hint">請輸入格式如 "120/80"。建議測量兩次取平均值。正常值：收縮壓 < 120、舒張壓 < 80</div>
        </div>

        <!-- 🆕 三餐選擇 - 數字選項 -->
        <div class="form-section">
            <div class="section-title">
                <span>🍽️</span>
                <span>三餐攝取</span>
            </div>

            <!-- 早餐 -->
            <div class="meal-section">
                <div class="meal-title">🌅 早餐</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">蔬菜</label>
                        <select class="form-select" id="breakfast-veg" name="Meals_Breakfast_Vegetables">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="breakfast-veg-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">蛋白質</label>
                        <select class="form-select" id="breakfast-protein" name="Meals_Breakfast_Protein">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="breakfast-protein-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">澱粉</label>
                        <select class="form-select" id="breakfast-carbs" name="Meals_Breakfast_Carbs">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="breakfast-carbs-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                </div>
            </div>

            <!-- 午餐 -->
            <div class="meal-section">
                <div class="meal-title">☀️ 午餐</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">蔬菜</label>
                        <select class="form-select" id="lunch-veg">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="lunch-veg-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">蛋白質</label>
                        <select class="form-select" id="lunch-protein">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="lunch-protein-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">澱粉</label>
                        <select class="form-select" id="lunch-carbs">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="lunch-carbs-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                </div>
            </div>

            <!-- 晚餐 -->
            <div class="meal-section">
                <div class="meal-title">🌙 晚餐</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">蔬菜</label>
                        <select class="form-select" id="dinner-veg">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="dinner-veg-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">蛋白質</label>
                        <select class="form-select" id="dinner-protein">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="dinner-protein-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">澱粉</label>
                        <select class="form-select" id="dinner-carbs">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="dinner-carbs-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                </div>
            </div>

            <!-- Hidden fields for MealSelection JSON -->
            <input type="hidden" id="Meals_Breakfast_Json" name="Meals_Breakfast" />
            <input type="hidden" id="Meals_Lunch_Json" name="Meals_Lunch" />
            <input type="hidden" id="Meals_Dinner_Json" name="Meals_Dinner" />
        </div>

        <!-- 運動資訊 -->
        <div class="form-section">
            <div class="section-title">
                <span>🏃</span>
                <span>運動資訊</span>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" asp-for="ExerciseType">運動種類</label>
                    <input asp-for="ExerciseType" class="form-control" placeholder="例如：慢跑、游泳、騎腳踏車" />
                </div>
                <div class="form-group">
                    <label class="form-label" asp-for="ExerciseDuration">運動時間 (分鐘)</label>
                    <input asp-for="ExerciseDuration" type="number" step="0.1" class="form-control" placeholder="0" />
                    <div class="input-hint">建議每日運動至少 150 分鐘</div>
                </div>
            </div>
        </div>

        <!-- 飲食資訊 -->
        <div class="form-section">
            <div class="section-title">
                <span>💧</span>
                <span>飲品攝取</span>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" asp-for="WaterIntake">水分攝取 (ml)</label>
                    <input asp-for="WaterIntake" type="number" class="form-control" placeholder="0" />
                    <div class="input-hint">建議每日飲水 2000 ml</div>
                </div>
                <div class="form-group">
                    <label class="form-label" asp-for="Beverage">其他飲料</label>
                    <input asp-for="Beverage" class="form-control" placeholder="例如:咖啡、茶、果汁" />
                </div>
            </div>
        </div>

        <!-- 生活習慣 -->
        <div class="form-section">
            <div class="section-title">
                <span>🚬</span>
                <span>生活習慣</span>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" asp-for="Cigarettes">抽菸支數</label>
                    <input asp-for="Cigarettes" type="number" class="form-control" placeholder="0" />
                    <div class="input-hint">建議戒菸以維護健康</div>
                </div>
                <div class="form-group">
                    <label class="form-label" asp-for="BetelNut">嚼檳榔次數</label>
                    <input asp-for="BetelNut" type="number" class="form-control" placeholder="0" />
                    <div class="input-hint">建議戒除檳榔以維護健康</div>
                </div>
            </div>
        </div>

        <!-- 生理數值 -->
        <div class="form-section">
            <div class="section-title">
                <span>🩸</span>
                <span>血糖</span>
            </div>
            <div class="form-group">
                <label class="form-label" asp-for="BloodSugar">血糖 (mg/dL)</label>
                <input asp-for="BloodSugar" type="number" step="0.1" class="form-control" placeholder="0" />
                <div class="input-hint">正常值：70-99 mg/dL</div>
            </div>
        </div>

        <div class="button-group">
            <a href="@Url.Action("Index", "DailyHealth")" class="btn btn-secondary">
                ← 取消
            </a>
            <button type="submit" class="btn btn-primary" onclick="return prepareMealData()">
                @(Model.Id > 0 ? "💾 儲存修改" : "✓ 下一步")
            </button>
        </div>
    </form>
</div>

<script>
    // 處理「其他」選項的顯示/隱藏
    function setupOtherInputs() {
        const selects = document.querySelectorAll('.form-select');
        selects.forEach(select => {
            const otherId = select.id + '-other';
            const otherInput = document.getElementById(otherId);
            
            if (otherInput) {
                select.addEventListener('change', function() {
                    if (this.value === '其他') {
                        otherInput.style.display = 'block';
                    } else {
                        otherInput.style.display = 'none';
                        otherInput.value = '';
                    }
                });
            }
        });
    }

    // 提交前準備三餐數據
    function prepareMealData() {
        // 早餐
        const breakfastVeg = document.getElementById('breakfast-veg').value;
        const breakfastProtein = document.getElementById('breakfast-protein').value;
        const breakfastCarbs = document.getElementById('breakfast-carbs').value;
        
        if (breakfastVeg || breakfastProtein || breakfastCarbs) {
            const breakfast = {
                Vegetables: breakfastVeg === '其他' ? document.getElementById('breakfast-veg-other').value : breakfastVeg,
                Protein: breakfastProtein === '其他' ? document.getElementById('breakfast-protein-other').value : breakfastProtein,
                Carbs: breakfastCarbs === '其他' ? document.getElementById('breakfast-carbs-other').value : breakfastCarbs
            };
            document.getElementById('Meals_Breakfast_Json').value = JSON.stringify(breakfast);
        }

        // 午餐
        const lunchVeg = document.getElementById('lunch-veg').value;
        const lunchProtein = document.getElementById('lunch-protein').value;
        const lunchCarbs = document.getElementById('lunch-carbs').value;
        
        if (lunchVeg || lunchProtein || lunchCarbs) {
            const lunch = {
                Vegetables: lunchVeg === '其他' ? document.getElementById('lunch-veg-other').value : lunchVeg,
                Protein: lunchProtein === '其他' ? document.getElementById('lunch-protein-other').value : lunchProtein,
                Carbs: lunchCarbs === '其他' ? document.getElementById('lunch-carbs-other').value : lunchCarbs
            };
            document.getElementById('Meals_Lunch_Json').value = JSON.stringify(lunch);
        }

        // 晚餐
        const dinnerVeg = document.getElementById('dinner-veg').value;
        const dinnerProtein = document.getElementById('dinner-protein').value;
        const dinnerCarbs = document.getElementById('dinner-carbs').value;
        
        if (dinnerVeg || dinnerProtein || dinnerCarbs) {
            const dinner = {
                Vegetables: dinnerVeg === '其他' ? document.getElementById('dinner-veg-other').value : dinnerVeg,
                Protein: dinnerProtein === '其他' ? document.getElementById('dinner-protein-other').value : dinnerProtein,
                Carbs: dinnerCarbs === '其他' ? document.getElementById('dinner-carbs-other').value : dinnerCarbs
            };
            document.getElementById('Meals_Dinner_Json').value = JSON.stringify(dinner);
        }

        return true;
    }

    // 頁面載入時初始化
    document.addEventListener('DOMContentLoaded', function() {
        setupOtherInputs();
        
        // 如果是編輯模式,恢復選項
        @if (Model.Meals_Breakfast != null)
        {
            <text>
            const breakfast = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Meals_Breakfast));
            if (breakfast.Vegetables) document.getElementById('breakfast-veg').value = breakfast.Vegetables;
            if (breakfast.Protein) document.getElementById('breakfast-protein').value = breakfast.Protein;
            if (breakfast.Carbs) document.getElementById('breakfast-carbs').value = breakfast.Carbs;
            </text>
        }
        
        @if (Model.Meals_Lunch != null)
        {
            <text>
            const lunch = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Meals_Lunch));
            if (lunch.Vegetables) document.getElementById('lunch-veg').value = lunch.Vegetables;
            if (lunch.Protein) document.getElementById('lunch-protein').value = lunch.Protein;
            if (lunch.Carbs) document.getElementById('lunch-carbs').value = lunch.Carbs;
            </text>
        }
        
        @if (Model.Meals_Dinner != null)
        {
            <text>
            const dinner = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Meals_Dinner));
            if (dinner.Vegetables) document.getElementById('dinner-veg').value = dinner.Vegetables;
            if (dinner.Protein) document.getElementById('dinner-protein').value = dinner.Protein;
            if (dinner.Carbs) document.getElementById('dinner-carbs').value = dinner.Carbs;
            </text>
        }
    });
</script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}