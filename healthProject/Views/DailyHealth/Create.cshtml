@model HealthRecordViewModel
@{
    ViewData["Title"] = Model.Id > 0 ? "編輯健康紀錄" : "新增今日健康紀錄";
    Layout = null;
}

<style>
    .form-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    body {
        background-color: #e5eef5;
        font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
        min-height: 100vh;
        margin: 0;
        padding: 0;
    }

    .form-header {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
    }

    .form-header h1 {
        margin: 0;
        font-size: 1.8rem;
    }

    .form-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
    }

    .form-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .section-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #06b6d4;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 3px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    @@media (min-width: 768px) {
        .form-row {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .form-control, .form-select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 1rem;
        font-family: inherit;
        transition: all 0.3s ease;
        background-color: white;
    }

    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: #06b6d4;
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
    }

    .input-hint {
        font-size: 0.85rem;
        color: #64748b;
        margin-top: 0.25rem;
    }

    .bp-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .bp-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .bp-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #475569;
    }

    .meal-section {
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: 10px;
        margin-bottom: 1rem;
    }

    .meal-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #0891b2;
        margin-bottom: 1rem;
    }

    .button-group {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
    }

    .btn {
        padding: 1rem 2.5rem;
        border: none;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
    }

    .btn-secondary {
        background: #e2e8f0;
        color: #475569;
    }

    .btn-secondary:hover {
        background: #cbd5e1;
        text-decoration: none;
        color: #475569;
    }

    .alert-info {
        background: #E3F2FD;
        border: 2px solid #42A5F5;
        color: #1565C0;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .alert-danger {
        background: #ffebee;
        border: 2px solid #ef5350;
        color: #c62828;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
    }

    @@media (max-width: 768px) {
        .bp-grid {
            grid-template-columns: 1fr;
        }
    }
</style>



<div class="form-container">
    <div class="form-header">
        <h1>📝 @ViewData["Title"]</h1>
        <p>@DateTime.Today.ToString("yyyy年MM月dd日")</p>
    </div>

    <form asp-action="@(Model.Id > 0 ? "Edit" : "Create")" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="UserId" />

        @if (TempData["InfoMessage"] != null)
        {
            <div class="alert-info">
                @TempData["InfoMessage"]
            </div>
        }

        @if (!ViewData.ModelState.IsValid)
        {
            <div class="alert-danger">
                <div asp-validation-summary="All"></div>
            </div>
        }

        <!-- 🆕 血壓 - 8 個獨立數字輸入框 (收縮壓/舒張壓分開) -->
        <div class="form-section">
            <div class="section-title">
                <span>❤️</span>
                <span>血壓測量 (mmHg)</span>
            </div>

            <!-- 測量說明 -->
            <div style="background: #E3F2FD; border-left: 4px solid #1976D2; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <strong style="color: #1565C0;">📍 測量時間說明:</strong>
                <div style="margin-top: 0.5rem; color: #1976D2; font-size: 0.9rem;">
                    • <strong>上午</strong>: 起床後 1 小時內,早餐前<br>
                    • <strong>睡前</strong>: 睡覺前 1 小時內<br>
                    • 每次測量間隔 1-2 分鐘,取兩遍的平均值
                </div>
            </div>

            <!-- 第一次 (上午) -->
            <div style="background: linear-gradient(135deg, #FFF9C4 0%, #FFF59D 100%); padding: 1.5rem; border-radius: 15px; margin-bottom: 1.5rem; border: 2px solid #FBC02D;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                    <span style="font-size: 1.5rem;">🌅</span>
                    <h4 style="margin: 0; color: #F57C00; font-weight: 700;">第一次 (上午)</h4>
                </div>

                <!-- 第一遍 -->
                <div style="background: rgba(255, 255, 255, 0.7); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #FFB300;">
                    <div style="font-weight: 600; color: #E65100; margin-bottom: 0.75rem; font-size: 1.05rem;">
                        📍 第一遍 <span style="color: #D84315;">*</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 500; color: #E65100; margin-bottom: 0.5rem;">
                                收縮壓 (上壓)
                            </label>
                            <input asp-for="BP_First_1_Systolic" type="number" class="form-control"
                                   placeholder="例: 120" min="50" max="250" step="1"
                                   style="padding: 0.75rem; border: 2px solid #FFB300; border-radius: 10px; font-size: 1.1rem; text-align: center;" />
                            <span asp-validation-for="BP_First_1_Systolic" class="text-danger"></span>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; color: #E65100; margin-bottom: 0.5rem;">
                                舒張壓 (下壓)
                            </label>
                            <input asp-for="BP_First_1_Diastolic" type="number" class="form-control"
                                   placeholder="例: 80" min="30" max="150" step="1"
                                   style="padding: 0.75rem; border: 2px solid #FFB300; border-radius: 10px; font-size: 1.1rem; text-align: center;" />
                            <span asp-validation-for="BP_First_1_Diastolic" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- 第二遍 -->
                <div style="background: rgba(255, 255, 255, 0.7); padding: 1rem; border-radius: 10px; border: 2px solid #FFD54F;">
                    <div style="font-weight: 600; color: #E65100; margin-bottom: 0.75rem; font-size: 1.05rem;">
                        📍 第二遍
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 500; color: #E65100; margin-bottom: 0.5rem;">
                                收縮壓 (上壓)
                            </label>
                            <input asp-for="BP_First_2_Systolic" type="number" class="form-control"
                                   placeholder="例: 118" min="50" max="250" step="1"
                                   style="padding: 0.75rem; border: 2px solid #FFD54F; border-radius: 10px; font-size: 1.1rem; text-align: center;" />
                            <span asp-validation-for="BP_First_2_Systolic" class="text-danger"></span>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; color: #E65100; margin-bottom: 0.5rem;">
                                舒張壓 (下壓)
                            </label>
                            <input asp-for="BP_First_2_Diastolic" type="number" class="form-control"
                                   placeholder="例: 78" min="30" max="150" step="1"
                                   style="padding: 0.75rem; border: 2px solid #FFD54F; border-radius: 10px; font-size: 1.1rem; text-align: center;" />
                            <span asp-validation-for="BP_First_2_Diastolic" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 0.75rem; padding: 0.5rem; background: rgba(255, 255, 255, 0.8); border-radius: 8px; font-size: 0.85rem; color: #E65100;">
                    💡若填第一遍，請記得填第二遍
                </div>
            </div>

            <!-- 第二次 (睡前) -->
            <div style="background: linear-gradient(135deg, #E1BEE7 0%, #CE93D8 100%); padding: 1.5rem; border-radius: 15px; margin-bottom: 1rem; border: 2px solid #9C27B0;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                    <span style="font-size: 1.5rem;">🌙</span>
                    <h4 style="margin: 0; color: #6A1B9A; font-weight: 700;">第二次 (睡前)</h4>
                </div>

                <!-- 第一遍 -->
                <div style="background: rgba(255, 255, 255, 0.7); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #AB47BC;">
                    <div style="font-weight: 600; color: #4A148C; margin-bottom: 0.75rem; font-size: 1.05rem;">
                        📍 第一遍
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 500; color: #4A148C; margin-bottom: 0.5rem;">
                                收縮壓 (上壓)
                            </label>
                            <input asp-for="BP_Second_1_Systolic" type="number" class="form-control"
                                   placeholder="例: 115" min="50" max="250" step="1"
                                   style="padding: 0.75rem; border: 2px solid #AB47BC; border-radius: 10px; font-size: 1.1rem; text-align: center;" />
                            <span asp-validation-for="BP_Second_1_Systolic" class="text-danger"></span>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; color: #4A148C; margin-bottom: 0.5rem;">
                                舒張壓 (下壓)
                            </label>
                            <input asp-for="BP_Second_1_Diastolic" type="number" class="form-control"
                                   placeholder="例: 75" min="30" max="150" step="1"
                                   style="padding: 0.75rem; border: 2px solid #AB47BC; border-radius: 10px; font-size: 1.1rem; text-align: center;" />
                            <span asp-validation-for="BP_Second_1_Diastolic" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- 第二遍 -->
                <div style="background: rgba(255, 255, 255, 0.7); padding: 1rem; border-radius: 10px; border: 2px solid #CE93D8;">
                    <div style="font-weight: 600; color: #4A148C; margin-bottom: 0.75rem; font-size: 1.05rem;">
                        📍 第二遍
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 500; color: #4A148C; margin-bottom: 0.5rem;">
                                收縮壓 (上壓)
                            </label>
                            <input asp-for="BP_Second_2_Systolic" type="number" class="form-control"
                                   placeholder="例: 117" min="50" max="250" step="1"
                                   style="padding: 0.75rem; border: 2px solid #CE93D8; border-radius: 10px; font-size: 1.1rem; text-align: center;" />
                            <span asp-validation-for="BP_Second_2_Systolic" class="text-danger"></span>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; color: #4A148C; margin-bottom: 0.5rem;">
                                舒張壓 (下壓)
                            </label>
                            <input asp-for="BP_Second_2_Diastolic" type="number" class="form-control"
                                   placeholder="例: 77" min="30" max="150" step="1"
                                   style="padding: 0.75rem; border: 2px solid #CE93D8; border-radius: 10px; font-size: 1.1rem; text-align: center;" />
                            <span asp-validation-for="BP_Second_2_Diastolic" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 0.75rem; padding: 0.5rem; background: rgba(255, 255, 255, 0.8); border-radius: 8px; font-size: 0.85rem; color: #4A148C;">
                    💡 若填第一遍，請記得填第二遍
                </div>
            </div>

            <!-- 總說明 -->
            <div class="input-hint" style="background: #F3E5F5; padding: 1rem; border-radius: 10px; border-left: 4px solid #9C27B0;">
                <strong style="color: #6A1B9A;">📋 血壓標準值:</strong>
                <ul style="margin: 0.5rem 0 0 1.5rem; color: #4A148C;">
                    <li>正常血壓: 收縮壓 &lt; 120 mmHg、舒張壓 &lt; 80 mmHg</li>
                    <li>高血壓前期: 收縮壓 120-139 mmHg 或 舒張壓 80-89 mmHg</li>
                    <li>高血壓: 收縮壓 ≥ 140 mmHg 或 舒張壓 ≥ 90 mmHg</li>
                </ul>
            </div>
        </div>

        <!-- 🆕 三餐選擇 - 數字選項 -->
        <div class="form-section">
            <div class="section-title">
                <span>🍽️</span>
                <span>三餐攝取</span>
            </div>

            <!-- 早餐 -->
            <div class="meal-section">
                <div class="meal-title">🌅 早餐</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">蔬菜</label>
                        <select class="form-select" id="breakfast-veg" name="Meals_Breakfast_Vegetables">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="breakfast-veg-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">蛋白質</label>
                        <select class="form-select" id="breakfast-protein" name="Meals_Breakfast_Protein">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="breakfast-protein-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">澱粉</label>
                        <select class="form-select" id="breakfast-carbs" name="Meals_Breakfast_Carbs">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="breakfast-carbs-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                </div>
            </div>

            <!-- 午餐 -->
            <div class="meal-section">
                <div class="meal-title">☀️ 午餐</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">蔬菜</label>
                        <select class="form-select" id="lunch-veg">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="lunch-veg-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">蛋白質</label>
                        <select class="form-select" id="lunch-protein">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="lunch-protein-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">澱粉</label>
                        <select class="form-select" id="lunch-carbs">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="lunch-carbs-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                </div>
            </div>

            <!-- 晚餐 -->
            <div class="meal-section">
                <div class="meal-title">🌙 晚餐</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">蔬菜</label>
                        <select class="form-select" id="dinner-veg">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="dinner-veg-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">蛋白質</label>
                        <select class="form-select" id="dinner-protein">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="dinner-protein-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">澱粉</label>
                        <select class="form-select" id="dinner-carbs">
                            <option value="">請選擇</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5 (拳頭)</option>
                            <option value="1">1 (拳頭)</option>
                            <option value="1.5">1.5 (拳頭)</option>
                            <option value="2">2 (拳頭)</option>
                            <option value="其他">其他 (請於下方輸入)</option>
                        </select>
                        <input type="text" class="form-control" id="dinner-carbs-other" placeholder="例如：半個拳頭多一點" style="margin-top: 0.5rem; display: none;" />
                    </div>
                </div>
            </div>

            <!-- Hidden fields for MealSelection JSON -->
            <input type="hidden" id="Meals_Breakfast_Json" name="Meals_Breakfast" />
            <input type="hidden" id="Meals_Lunch_Json" name="Meals_Lunch" />
            <input type="hidden" id="Meals_Dinner_Json" name="Meals_Dinner" />
        </div>

        <!-- 運動資訊 -->
        <div class="form-section">
            <div class="section-title">
                <span>🏃</span>
                <span>運動資訊</span>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" asp-for="ExerciseType">運動種類</label>
                    <input asp-for="ExerciseType" class="form-control" placeholder="例如：慢跑、游泳、騎腳踏車" />
                </div>
                <div class="form-group">
                    <label class="form-label" asp-for="ExerciseDuration">運動時間 (分鐘)</label>
                    <input asp-for="ExerciseDuration" type="number" step="0.1" class="form-control" placeholder="0" />
                    <div class="input-hint">建議每日運動至少 150 分鐘</div>
                </div>
            </div>
        </div>

        <!-- 飲食資訊 -->
        <div class="form-section">
            <div class="section-title">
                <span>💧</span>
                <span>飲品攝取</span>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" asp-for="WaterIntake">水分攝取 (ml)</label>
                    <input asp-for="WaterIntake" type="number" class="form-control" placeholder="0" />
                    <div class="input-hint">建議每日飲水 2000 ml</div>
                </div>
                <div class="form-group">
                    <label class="form-label" asp-for="Beverage">其他飲料</label>
                    <input asp-for="Beverage" class="form-control" placeholder="例如:咖啡、茶、果汁" />
                </div>
            </div>
        </div>

        <!-- 生活習慣 -->
        <div class="form-section">
            <div class="section-title">
                <span>🚬</span>
                <span>生活習慣</span>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" asp-for="Cigarettes">抽菸支數</label>
                    <input asp-for="Cigarettes" type="number" class="form-control" placeholder="0" />
                    <div class="input-hint">建議戒菸以維護健康</div>
                </div>
                <div class="form-group">
                    <label class="form-label" asp-for="BetelNut">嚼檳榔次數</label>
                    <input asp-for="BetelNut" type="number" class="form-control" placeholder="0" />
                    <div class="input-hint">建議戒除檳榔以維護健康</div>
                </div>
            </div>
        </div>

        <!-- 生理數值 -->
        <div class="form-section">
            <div class="section-title">
                <span>🩸</span>
                <span>血糖</span>
            </div>
            <div class="form-group">
                <label class="form-label" asp-for="BloodSugar">血糖 (mg/dL)</label>
                <input asp-for="BloodSugar" type="number" step="0.1" class="form-control" placeholder="0" />
                <div class="input-hint">正常值：70-99 mg/dL</div>
            </div>
        </div>

        <div class="button-group">
            <a href="@Url.Action("Index", "DailyHealth")" class="btn btn-secondary">
                ← 取消
            </a>
            <button type="submit" class="btn btn-primary" onclick="return prepareMealData()">
                @(Model.Id > 0 ? "💾 儲存修改" : "✓ 下一步")
            </button>
        </div>
    </form>
</div>

<script>
    // 處理「其他」選項的顯示/隱藏
    function setupOtherInputs() {
        const selects = document.querySelectorAll('.form-select');
        selects.forEach(select => {
            const otherId = select.id + '-other';
            const otherInput = document.getElementById(otherId);

            if (otherInput) {
                select.addEventListener('change', function () {
                    if (this.value === '其他') {
                        otherInput.style.display = 'block';
                    } else {
                        otherInput.style.display = 'none';
                        otherInput.value = '';
                    }
                });
            }
        });
    }

    // 🆕 恢復三餐選項 (包括「其他」文字的處理)
    function restoreMealSelection(selectId, otherInputId, value) {
        if (!value) return;

        const selectElement = document.getElementById(selectId);
        const otherInput = document.getElementById(otherInputId);

        // 檢查是否為預設選項
        const validOptions = ['0', '0.5', '1', '1.5', '2'];
        if (validOptions.includes(value)) {
            selectElement.value = value;
        } else {
            // 不是預設選項,設為「其他」並填入文字框
            selectElement.value = '其他';
            otherInput.style.display = 'block';
            otherInput.value = value;
        }
    }

    // 提交前準備三餐數據
    function prepareMealData() {
        // 早餐
        const breakfastVeg = document.getElementById('breakfast-veg').value;
        const breakfastProtein = document.getElementById('breakfast-protein').value;
        const breakfastCarbs = document.getElementById('breakfast-carbs').value;

        if (breakfastVeg || breakfastProtein || breakfastCarbs) {
            const breakfast = {
                Vegetables: breakfastVeg === '其他' ? document.getElementById('breakfast-veg-other').value : breakfastVeg,
                Protein: breakfastProtein === '其他' ? document.getElementById('breakfast-protein-other').value : breakfastProtein,
                Carbs: breakfastCarbs === '其他' ? document.getElementById('breakfast-carbs-other').value : breakfastCarbs
            };
            document.getElementById('Meals_Breakfast_Json').value = JSON.stringify(breakfast);
        }

        // 午餐
        const lunchVeg = document.getElementById('lunch-veg').value;
        const lunchProtein = document.getElementById('lunch-protein').value;
        const lunchCarbs = document.getElementById('lunch-carbs').value;

        if (lunchVeg || lunchProtein || lunchCarbs) {
            const lunch = {
                Vegetables: lunchVeg === '其他' ? document.getElementById('lunch-veg-other').value : lunchVeg,
                Protein: lunchProtein === '其他' ? document.getElementById('lunch-protein-other').value : lunchProtein,
                Carbs: lunchCarbs === '其他' ? document.getElementById('lunch-carbs-other').value : lunchCarbs
            };
            document.getElementById('Meals_Lunch_Json').value = JSON.stringify(lunch);
        }

        // 晚餐
        const dinnerVeg = document.getElementById('dinner-veg').value;
        const dinnerProtein = document.getElementById('dinner-protein').value;
        const dinnerCarbs = document.getElementById('dinner-carbs').value;

        if (dinnerVeg || dinnerProtein || dinnerCarbs) {
            const dinner = {
                Vegetables: dinnerVeg === '其他' ? document.getElementById('dinner-veg-other').value : dinnerVeg,
                Protein: dinnerProtein === '其他' ? document.getElementById('dinner-protein-other').value : dinnerProtein,
                Carbs: dinnerCarbs === '其他' ? document.getElementById('dinner-carbs-other').value : dinnerCarbs
            };
            document.getElementById('Meals_Dinner_Json').value = JSON.stringify(dinner);
        }

        return true;
    }

    // 頁面載入時初始化
    document.addEventListener('DOMContentLoaded', function () {
        setupOtherInputs();

        // 🆕 如果是編輯模式,恢復三餐選項
        @if (Model.Meals_Breakfast != null)
        {
            <text>
            const breakfast = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Meals_Breakfast));
            console.log('恢復早餐資料:', breakfast);
            if (breakfast.Vegetables) {
                restoreMealSelection('breakfast-veg', 'breakfast-veg-other', breakfast.Vegetables);
            }
            if (breakfast.Protein) {
                restoreMealSelection('breakfast-protein', 'breakfast-protein-other', breakfast.Protein);
            }
            if (breakfast.Carbs) {
                restoreMealSelection('breakfast-carbs', 'breakfast-carbs-other', breakfast.Carbs);
            }
            </text>
        }

        @if (Model.Meals_Lunch != null)
        {
            <text>
            const lunch = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Meals_Lunch));
            console.log('恢復午餐資料:', lunch);
            if (lunch.Vegetables) {
                restoreMealSelection('lunch-veg', 'lunch-veg-other', lunch.Vegetables);
            }
            if (lunch.Protein) {
                restoreMealSelection('lunch-protein', 'lunch-protein-other', lunch.Protein);
            }
            if (lunch.Carbs) {
                restoreMealSelection('lunch-carbs', 'lunch-carbs-other', lunch.Carbs);
            }
            </text>
        }

        @if (Model.Meals_Dinner != null)
        {
            <text>
            const dinner = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Meals_Dinner));
            console.log('恢復晚餐資料:', dinner);
            if (dinner.Vegetables) {
                restoreMealSelection('dinner-veg', 'dinner-veg-other', dinner.Vegetables);
            }
            if (dinner.Protein) {
                restoreMealSelection('dinner-protein', 'dinner-protein-other', dinner.Protein);
            }
            if (dinner.Carbs) {
                restoreMealSelection('dinner-carbs', 'dinner-carbs-other', dinner.Carbs);
            }
            </text>
        }
    });
</script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}